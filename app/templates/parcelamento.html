{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-credit-card"></i> Simulação de Parcelamento</h2>
  <span class="text-muted">Condições para <strong>{{ produto.nome }}</strong></span>
</div>

<!-- Resumo do produto -->
<div class="card shadow-sm mb-4">
  <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
    <div>
      <h5 class="card-title mb-1">{{ produto.nome }}</h5>
      <small class="text-muted">SKU: {{ produto.sku }}</small>
    </div>
    <span class="badge bg-primary fs-5 mt-2 mt-md-0">
      À vista: {{ (produto.preco_final or produto.preco_a_vista)|currency }}
    </span>
  </div>
</div>

<!-- Tabela de Parcelamento em Cards -->
<div class="row g-3">
  <!-- PIX -->
  <div class="col-12 col-md-4">
    <div class="card shadow-sm h-100 text-center card-parcela">
      <div class="card-body">
        <span class="badge bg-success mb-2">PIX</span>
        <h5 class="fw-bold">{{ (produto.preco_final or produto.preco_a_vista)|currency }}</h5>
        <small class="text-muted">Total: {{ (produto.preco_final or produto.preco_a_vista)|currency }}</small>
      </div>
    </div>
  </div>

  <!-- Débito -->
  {% set debito_total = (produto.preco_final or produto.preco_a_vista) / (1 - 0.0109) %}
  <div class="col-12 col-md-4">
    <div class="card shadow-sm h-100 text-center card-parcela">
      <div class="card-body">
        <span class="badge bg-info mb-2">Débito</span>
        <h5 class="fw-bold">{{ debito_total|currency }}</h5>
        <small class="text-muted">Total: {{ debito_total|currency }}</small>
      </div>
    </div>
  </div>

  <!-- Demais planos -->
  {% for r in resultado %}
  <div class="col-12 col-md-4">
    <div class="card shadow-sm h-100 text-center card-parcela">
      <div class="card-body">
        <span class="badge bg-secondary mb-2">{{ r.rotulo }}</span>
        <h5 class="fw-bold">{{ r.parcela|currency }}</h5>
        <small class="text-muted">Total: {{ r.total|currency }}</small>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<div class="mt-4 text-end">
  <button id="btnCopy" class="btn btn-success">
    <i class="fas fa-copy me-1"></i> Copiar para WhatsApp
  </button>
</div>

<script>
  const textoWhats = {{ texto_whats|tojson|safe }};

  document.getElementById('btnCopy').addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(textoWhats);

      // feedback visual simples
      const btn = document.getElementById('btnCopy');
      const original = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
      btn.classList.remove('btn-success');
      btn.classList.add('btn-primary');

      setTimeout(() => {
        btn.innerHTML = original;
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
      }, 2000);

    } catch (e) {
      console.error(e);
      alert('Não foi possível copiar. Tente novamente.');
    }
  });
</script>
{% endblock %}
