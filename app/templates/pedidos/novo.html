{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-plus"></i> {{ 'Editar Pedido de Compra' if pedido else 'Novo Pedido de Compra' }}</h2>
    <a href="{{ url_for('pedidos.listar_pedidos') }}" class="btn btn-secondary">Voltar</a>
</div>

<form method="POST">
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="fornecedor" class="form-label fw-bold">Fornecedor</label>
                    <select class="form-select select2" id="fornecedor" name="fornecedor" required>
                        <option value="">Selecione...</option>
                        {% for f in fornecedores %}
                            <option value="{{ f.id }}" {% if pedido and pedido.fornecedor_id == f.id %}selected{% endif %}>
                                {{ f.nome }} - {{ f.documento }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="cond_pagto" class="form-label">Condição de Pagamento</label>
                    <input type="text" class="form-control" id="cond_pagto" name="cond_pagto"
                           value="{{ pedido.cond_pagto if pedido else '' }}"
                           placeholder="Ex: À vista, 30/60 dias" required>
                </div>

                {% if pedido %}
                <div class="col-md-3">
                    <label for="status" class="form-label fw-bold text-primary">Status Atual</label>
                    <select name="status" id="status" class="form-select border-primary fw-bold text-primary">
                        <option value="Aguardando" {% if pedido.status == 'Aguardando' %}selected{% endif %}>Aguardando</option>
                        <option value="Aguardando NF" {% if pedido.status == 'Aguardando NF' %}selected{% endif %}>Aguardando NF</option>
                        <option value="Confirmado" {% if pedido.status == 'Confirmado' %}selected{% endif %}>Confirmado</option>
                        <option value="Em Transito" {% if pedido.status == 'Em Transito' %}selected{% endif %}>Em Trânsito</option>
                        <option value="Recebido" {% if pedido.status == 'Recebido' %}selected{% endif %}>Recebido</option>
                        <option value="Cancelado" {% if pedido.status == 'Cancelado' %}selected{% endif %}>Cancelado</option>
                    </select>
                </div>
                {% else %}
                <div class="col-md-3">
                    <label class="form-label text-muted">Status</label>
                    <input type="text" class="form-control bg-light" value="Novo (Aguardando)" readonly>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <label class="form-label d-block fw-bold">Modo de desconto / Acréscimo</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="modo_desconto" id="modo_tipo" value="por_tipo"
                       {% if not pedido or pedido.modo_desconto == 'por_tipo' %}checked{% endif %}>
                <label class="form-check-label" for="modo_tipo">Por tipo (Armas/Munições)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="modo_desconto" id="modo_unico" value="unico"
                       {% if pedido and pedido.modo_desconto == 'unico' %}checked{% endif %}>
                <label class="form-check-label" for="modo_unico">Único percentual</label>
            </div>

            <div id="grupo_por_tipo" class="row g-3 mt-2 {% if pedido and pedido.modo_desconto == 'unico' %}d-none{% endif %}">
                <div class="col-md-6">
                    <label for="percentual_armas" class="form-label">Percentual Armas (%)</label>
                    <input type="number" step="0.01" class="form-control" id="percentual_armas" name="percentual_armas"
                           value="{{ pedido.percentual_armas if pedido else -5.0 }}">
                </div>
                <div class="col-md-6">
                    <label for="percentual_municoes" class="form-label">Percentual Munições (%)</label>
                    <input type="number" step="0.01" class="form-control" id="percentual_municoes" name="percentual_municoes"
                           value="{{ pedido.percentual_municoes if pedido else -3.0 }}">
                </div>
            </div>

            <div id="grupo_unico" class="row g-3 mt-2 {% if not pedido or pedido.modo_desconto != 'unico' %}d-none{% endif %}">
                <div class="col-md-6">
                    <label for="percentual_unico" class="form-label">Percentual Único (%)</label>
                    <input type="number" step="0.01" class="form-control" id="percentual_unico" name="percentual_unico"
                           value="{{ pedido.percentual_unico if pedido else 0 }}">
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Itens do Pedido</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" id="adicionar-linha">
                <i class="fas fa-plus"></i> Adicionar Item
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered mb-0" id="tabela-itens">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 15%">Código</th>
                            <th>Descrição</th>
                            <th style="width: 10%">Qtd</th>
                            <th style="width: 15%">Unitário (R$)</th>
                            <th style="width: 15%">Total (R$)</th>
                            <th style="width: 5%"></th>
                        </tr>
                    </thead>
                    <tbody id="containerItens">
                        {% if pedido and pedido.itens %}
                            {% for item in pedido.itens %}
                            <tr class="item-row">
                                <td><input type="text" name="codigo[]" class="form-control form-control-sm" value="{{ item.codigo }}"></td>
                                <td><input type="text" name="descricao[]" class="form-control form-control-sm" value="{{ item.descricao }}"></td>
                                <td><input type="number" name="quantidade[]" class="form-control form-control-sm qtd" step="1" min="1" value="{{ item.quantidade }}"></td>
                                <td><input type="text" name="valor_unitario[]" class="form-control form-control-sm unit"
                                           value="{{ ('%.2f' % (item.valor_unitario or 0))|replace('.', ',') }}"></td>
                                <td><input type="text" class="form-control form-control-sm total-item bg-light" readonly></td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-danger btn-sm remover-linha"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr class="item-row">
                                <td><input type="text" name="codigo[]" class="form-control form-control-sm"></td>
                                <td><input type="text" name="descricao[]" class="form-control form-control-sm" required></td>
                                <td><input type="number" name="quantidade[]" class="form-control form-control-sm qtd" value="1" min="1" required></td>
                                <td><input type="text" name="valor_unitario[]" class="form-control form-control-sm unit" required></td>
                                <td><input type="text" class="form-control form-control-sm total-item bg-light" readonly></td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-danger btn-sm remover-linha"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white text-end">
            <h4>Total: <span id="total-pedido" class="text-success fw-bold">R$ 0,00</span></h4>
        </div>
    </div>

    <div class="text-end mb-5">
        <button type="submit" class="btn btn-success btn-lg"><i class="fas fa-save me-2"></i> Salvar Pedido</button>
    </div>
</form>

<script src="https://unpkg.com/imask"></script>
<script>
// (Mantido o script original de cálculo e máscara que você já tinha, apenas ajustado se necessário)
/* Alterna grupos de percentuais */
document.querySelectorAll('input[name="modo_desconto"]').forEach(r => {
  r.addEventListener('change', () => {
    const unico = document.getElementById('modo_unico').checked;
    document.getElementById('grupo_unico').classList.toggle('d-none', !unico);
    document.getElementById('grupo_por_tipo').classList.toggle('d-none', unico);
    atualizarTotais();
  });
});

/* Adicionar nova linha */
document.getElementById('adicionar-linha').addEventListener('click', () => {
    const tbody = document.getElementById('containerItens');
    const linha = document.createElement('tr');
    linha.className = 'item-row';
    linha.innerHTML = `
        <td><input type="text" name="codigo[]" class="form-control form-control-sm"></td>
        <td><input type="text" name="descricao[]" class="form-control form-control-sm" required></td>
        <td><input type="number" name="quantidade[]" class="form-control form-control-sm qtd" step="1" min="1" required></td>
        <td><input type="text" name="valor_unitario[]" class="form-control form-control-sm unit" required></td>
        <td><input type="text" class="form-control form-control-sm total-item bg-light" readonly></td>
        <td class="text-center"><button type="button" class="btn btn-danger btn-sm remover-linha"><i class="fas fa-trash"></i></button></td>
    `;
    tbody.appendChild(linha);
    aplicarMascara();
});

/* Remover linha */
document.addEventListener('click', (e) => {
    if (e.target.closest('.remover-linha')) {
        e.target.closest('tr').remove();
        atualizarTotais();
    }
});

function classificarTipo(desc) {
    const d = desc.toLowerCase();
    if (d.includes("rifl") || d.includes("rifle") || d.includes("pist") || d.includes("rev") || d.includes("carabina") || d.includes("esp")) return "armas";
    if (d.includes("mun") || d.includes("cart") || d.includes("espol") || d.includes("esto") || d.includes("polv")) return "municoes";
    return "outros";
}

function atualizarTotais() {
    let totalPedido = 0;
    const percArmas = parseFloat(document.getElementById("percentual_armas")?.value.replace(",", ".") || 0);
    const percMunicoes = parseFloat(document.getElementById("percentual_municoes")?.value.replace(",", ".") || 0);
    const percUnico = parseFloat(document.getElementById("percentual_unico")?.value.replace(",", ".") || 0);
    const modoUnico = document.getElementById("modo_unico").checked;

    document.querySelectorAll(".item-row").forEach(tr => {
        const qtd = parseFloat(tr.querySelector(".qtd")?.value.replace(",", ".") || 0);
        const desc = tr.querySelector("input[name='descricao[]']")?.value || "";
        let unitStr = tr.querySelector(".unit")?.value || "0";
        unitStr = unitStr.replace(/\s/g, '').replace('R$', '').replace(/\./g, '').replace(',', '.');
        const unit = parseFloat(unitStr) || 0;

        let pct = 0;
        if (modoUnico) pct = percUnico;
        else {
            const tipo = classificarTipo(desc);
            pct = tipo === "armas" ? percArmas : (tipo === "municoes" ? percMunicoes : 0);
        }

        const precoFinal = unit * (1 + pct / 100);
        const total = qtd * precoFinal;

        tr.querySelector(".total-item").value = total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        totalPedido += total;
    });

    document.getElementById("total-pedido").textContent = totalPedido.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

document.addEventListener("input", (e) => {
    if (e.target.classList.contains("qtd") || e.target.classList.contains("unit") || 
        e.target.id === "percentual_armas" || e.target.id === "percentual_municoes" || 
        e.target.id === "percentual_unico" || e.target.name === "modo_desconto" || 
        e.target.name === "descricao[]") {
        atualizarTotais();
    }
});

function aplicarMascara() {
    document.querySelectorAll('input.unit').forEach(el => {
        if (!el._imask) {
            IMask(el, {
                mask: 'R$ num',
                blocks: {
                    num: {
                        mask: Number,
                        scale: 2,
                        thousandsSeparator: '.',
                        padFractionalZeros: true,
                        radix: ','
                    }
                }
            });
            el._imask = true;
        }
    });
}

document.addEventListener("DOMContentLoaded", () => {
    aplicarMascara();
    atualizarTotais();
    // Inicia Select2 se disponível
    if (window.jQuery && window.jQuery.fn.select2) {
        $('.select2').select2({ theme: 'bootstrap-5' });
    }
});
</script>
{% endblock %}