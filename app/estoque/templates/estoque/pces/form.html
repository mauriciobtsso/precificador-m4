{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4><i class="fas fa-cog me-2 text-primary"></i>Novo PCE</h4>
    <a href="{{ url_for('estoque.pces_listar') }}" class="btn btn-secondary">Voltar</a>
  </div>

  <form method="POST">
    <div class="m4-card mb-4">
      <h5><i class="fas fa-tags me-2"></i>Produto e Fornecedor</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Produto</label>
          <select name="produto_id" class="form-select" required>
            <option value="">Selecione...</option>
            {% for p in produtos %}
              <option value="{{ p.id }}">{{ p.nome }} ({{ p.codigo }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Fornecedor</label>
          <select name="fornecedor_id" class="form-select">
            <option value="">Selecione...</option>
            {% for f in fornecedores %}
              <option value="{{ f.id }}">{{ f.nome }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div class="m4-card mb-4">
      <h5><i class="fas fa-barcode me-2"></i>Identificação e Controle</h5>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Número de Série</label>
          <input type="text" name="numero_serie" class="form-control" placeholder="Ex.: PCE12345">
        </div>
        <div class="col-md-4">
          <label class="form-label">Quantidade</label>
          <input type="number" name="quantidade" class="form-control" value="1" min="1">
        </div>
        <div class="col-md-4">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="disponivel">Disponível</option>
            <option value="reservado">Reservado</option>
            <option value="instalado">Instalado</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Observações</label>
          <textarea name="observacoes" rows="3" class="form-control"></textarea>
        </div>
      </div>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-success"><i class="fas fa-save me-1"></i> Salvar</button>
    </div>
  </form>
</div>
{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const selectProduto = document.querySelector("select[name='produto_id']");
  if (!selectProduto) return;

  // Detecta o tipo de item conforme o módulo atual (ajuste o tipo abaixo)
  const tipoItem = "{{ tipo_item }}"; // valor passado pelo render_template()

  // Mostra indicador temporário
  selectProduto.innerHTML = '<option>Carregando produtos...</option>';

  fetch(`/estoque/api/produtos/${tipoItem}`)
    .then(res => {
      if (!res.ok) throw new Error("Erro ao buscar produtos");
      return res.json();
    })
    .then(data => {
      selectProduto.innerHTML = '<option value="">Selecione...</option>';
      if (!data.length) {
        selectProduto.innerHTML += '<option disabled>Nenhum produto encontrado</option>';
        return;
      }

      // Preenche dinamicamente as opções
      data.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.nome} (${p.codigo || "sem código"})`;
        selectProduto.appendChild(opt);
      });

      // Restaura valor anterior se houver (por validação)
      const antigo = selectProduto.getAttribute("data-valor");
      if (antigo) selectProduto.value = antigo;
    })
    .catch(err => {
      console.error("Erro ao carregar produtos:", err);
      selectProduto.innerHTML = '<option disabled>Falha ao carregar produtos</option>';
    });
});
</script>
{% endblock %}

{% endblock %}
