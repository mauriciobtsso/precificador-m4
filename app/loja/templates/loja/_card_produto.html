<div class="col">
    <div class="card h-100 product-card-m4 border-0">
        {# Lógica de Preços e Badges #}
        {% set precos = produto.calcular_precos() %}
        
        {# Badges de Status #}
        <div class="m4-badge-container">
            {% if precos.em_oferta %}
                <span class="m4-badge badge-sale">-15% OFF</span>
            {% elif produto.eh_lancamento %}
                <span class="m4-badge badge-new">NOVO</span>
            {% endif %}
        </div>

        {# Botão Wishlist #}
        <button class="m4-wishlist-btn" title="Adicionar aos favoritos">
            <i class="bi bi-heart"></i>
        </button>

        {# Container de Imagem #}
        <a href="{{ url_for('loja.detalhe_produto', slug=produto.slug) }}" class="text-decoration-none">
<div class="m4-img-container">
    {# Tenta encontrar a imagem em qualquer um dos campos possíveis do banco #}
    {% set imagem = produto.foto_url or produto.imagem_principal or produto.imagem_url or produto.foto %}
    
    {% if imagem %}
        {# O 'gerar_link' já deve estar tratando a limpeza do path do R2 #}
        <img src="{{ gerar_link(imagem) }}" 
             alt="{{ produto.nome }}" 
             class="m4-product-img"
             onerror="this.onerror=null;this.src='/static/img/placeholder.jpg';">
    {% else %}
        <div class="text-center">
            <i class="bi bi-image" style="font-size: 48px; opacity: 0.1;"></i>
            <p class="small text-muted m-0" style="font-size: 10px;">SEM FOTO NO BANCO</p>
        </div>
    {% endif %}
</div>
        </a>

        {# Informações do Produto #}
        <div class="card-body p-0 pt-3 text-start">
            <span class="m4-brand-label">{{ produto.marca.nome if produto.marca else 'M4 TÁTICA' }}</span>
            <h6 class="m4-product-name">
                <a href="{{ url_for('loja.detalhe_produto', slug=produto.slug) }}">
                    {{ produto.nome }}
                </a>
            </h6>
            
            <div class="mt-3 price-box">
                {% if precos.em_oferta %}
                    <p class="m4-old-price">R$ {{ "{:,.2f}".format(produto.preco_tabela).replace(',', 'X').replace('.', ',').replace('X', '.') }}</p>
                {% endif %}
                
                <p class="m4-main-price">R$ {{ "{:,.2f}".format(precos.preco_a_vista).replace(',', 'X').replace('.', ',').replace('X', '.') }}</p>
                
                <p class="m4-installments">
                    Ou 12x de <span class="fw-bold">R$ {{ "{:,.2f}".format(precos.preco_a_vista / 12).replace(',', 'X').replace('.', ',').replace('X', '.') }}</span>
                </p>
                
                <p class="text-success small fw-bold mt-1" style="font-size: 10px;">
                    <i class="bi bi-lightning-charge-fill"></i> PREÇO À VISTA NO PIX
                </p>
            </div>
        </div>

        {# Chamada para Ação (CTA) #}
        <div class="mt-3">
            <a href="{{ url_for('loja.detalhe_produto', slug=produto.slug) }}" class="m4-btn-details">
                VER DETALHES
            </a>
        </div>
    </div>
</div>

<style>
    :root {
        --m4-gold: #c5a059;
        --m4-danger: #d9534f;
        --m4-gray-bg: #f8f9fa;
    }

    .product-card-m4 {
        background: transparent;
        position: relative;
        transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }

    .product-card-m4:hover {
        transform: translateY(-8px);
    }

    /* Badges */
    .m4-badge-container {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 10;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .m4-badge {
        color: #fff;
        font-size: 9px;
        font-weight: 900;
        padding: 4px 10px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }

    .badge-sale { background: var(--m4-danger); }
    .badge-new { background: var(--m4-gold); color: #000 !important; }

    .m4-wishlist-btn {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 10;
        background: none;
        border: none;
        color: #ccc;
        font-size: 18px;
        cursor: pointer;
        transition: 0.3s;
        padding: 4px;
    }

    .m4-wishlist-btn:hover {
        color: var(--m4-danger);
        transform: scale(1.2);
    }

    /* Imagem */
    .m4-img-container {
        background-color: var(--m4-gray-bg);
        height: 240px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        overflow: hidden;
        transition: background-color 0.3s;
        border-radius: 4px;
    }

    .product-card-m4:hover .m4-img-container {
        background-color: #f0f0f0;
    }

    .m4-product-img {
        max-height: 100%;
        max-width: 100%;
        object-fit: contain;
        transition: transform 0.6s ease;
    }

    .product-card-m4:hover .m4-product-img {
        transform: scale(1.08);
    }

    /* Info Texto */
    .m4-brand-label {
        font-size: 9px;
        font-weight: 800;
        color: #aaa;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        display: block;
        margin-bottom: 4px;
    }

    .m4-product-name {
        font-size: 14px;
        font-weight: 700;
        height: 40px;
        overflow: hidden;
        line-height: 1.4;
        margin: 0;
    }

    .m4-product-name a {
        color: #111;
        text-decoration: none;
        transition: 0.2s;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .m4-product-name a:hover {
        color: var(--m4-gold);
    }

    /* Preços */
    .price-box { min-height: 85px; }

    .m4-old-price {
        font-size: 11px;
        text-decoration: line-through;
        color: #bbb;
        margin: 0;
    }

    .m4-main-price {
        font-size: 20px;
        font-weight: 900;
        color: #000;
        margin: 0;
        letter-spacing: -0.5px;
    }

    .m4-installments {
        font-size: 11px;
        color: #666;
        margin: 0;
    }

    /* Botão Detalhes */
    .m4-btn-details {
        display: block;
        width: 100%;
        padding: 12px;
        background: transparent;
        border: 1px solid #eee;
        color: #333;
        font-size: 11px;
        font-weight: 800;
        text-align: center;
        text-decoration: none;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        transition: 0.3s;
        border-radius: 4px;
    }

    .product-card-m4:hover .m4-btn-details {
        background-color: #000;
        color: #fff;
        border-color: #000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Responsivo */
    @media (max-width: 768px) {
        .m4-img-container { height: 200px; padding: 15px; }
        .m4-main-price { font-size: 17px; }
        .m4-product-name { font-size: 12px; height: 34px; }
    }
</style>