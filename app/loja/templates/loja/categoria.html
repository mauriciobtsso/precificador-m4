{% extends 'loja/base.html' %}

{% block content %}
<div class="container-fluid px-lg-5 mt-4">
    {# BREADCRUMB - Navegação Profissional #}
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-transparent p-0 small">
            <li class="breadcrumb-item"><a href="{{ url_for('loja.index') }}" class="text-muted text-decoration-none">Home</a></li>
            <li class="breadcrumb-item active fw-bold text-dark" aria-current="page">{{ categoria_ativa.nome }}</li>
        </ol>
    </nav>

    <div class="row">
        {# SIDEBAR INTELIGENTE #}
        <aside class="col-lg-3">
            <div class="sidebar-loja sticky-top" style="top: 110px; z-index: 100;">
                <div class="bg-white p-4 border-0 shadow-sm rounded">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="fw-bold mb-0 filter-title h5">FILTROS</h2>
                        {% if filtros.marca or filtros.calibre or filtros.preco_max %}
                        <a href="{{ url_for('loja.categoria', slug_categoria=categoria_ativa.slug) }}" class="badge bg-danger text-decoration-none" aria-label="Limpar todos os filtros">Limpar</a>
                        {% endif %}
                    </div>
                    
                    {# FAIXA DE PREÇO #}
                    <div class="mb-4">
                        <h3 class="fw-bold mb-3 small text-uppercase" style="font-size: 0.9rem;">Faixa de Preço</h3>
                        <div class="list-group list-group-flush" role="group" aria-label="Filtros de preço">
                            {% set faixas = [
                                (500, 'Até R$ 500'),
                                (2000, 'Até R$ 2.000'),
                                (5000, 'Até R$ 5.000'),
                                (10000, 'Até R$ 10.000'),
                                (20000, 'Até R$ 20.000')
                            ] %}
                            {% for valor, label in faixas %}
                            <a href="{{ url_for('loja.categoria', slug_categoria=categoria_ativa.slug, preco_max=valor, marca=filtros.marca, calibre=filtros.calibre) }}" 
                               class="filter-link {{ 'active' if filtros.preco_max == valor else '' }}"
                               aria-label="Filtrar por preço: {{ label }}"
                               {% if filtros.preco_max == valor %}aria-current="true"{% endif %}>
                                <span><i class="bi {{ 'bi-check-circle-fill' if filtros.preco_max == valor else 'bi-circle' }} me-2" aria-hidden="true"></i>{{ label }}</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>

                    {# MARCAS SUGERIDAS (DINÂMICAS) #}
                    {% if marcas %}
                    <div class="mb-4">
                        <h3 class="fw-bold mb-3 small text-uppercase" style="font-size: 0.9rem;">Marcas Disponíveis</h3>
                        <div class="filter-scroll pe-2" style="max-height: 250px; overflow-y: auto;" role="group" aria-label="Filtros de marca">
                            {% for m in marcas %}
                            <a href="{{ url_for('loja.categoria', slug_categoria=categoria_ativa.slug, marca=m.id, calibre=filtros.calibre, preco_max=filtros.preco_max) }}" 
                               class="filter-link {{ 'active' if filtros.marca == m.id else '' }}"
                               {% if filtros.marca == m.id %}aria-current="true"{% endif %}>
                                {{ m.nome }} <span class="filter-count" aria-label="{{ m.produtos|length }} produtos">{{ m.produtos|length }}</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {# CALIBRES SUGERIDOS #}
                    {% if calibres %}
                    <div class="mb-4">
                        <h3 class="fw-bold mb-3 small text-uppercase" style="font-size: 0.9rem;">Calibres</h3>
                        <div class="filter-scroll pe-2" style="max-height: 200px; overflow-y: auto;" role="group" aria-label="Filtros de calibre">
                            {% for c in calibres %}
                            <a href="{{ url_for('loja.categoria', slug_categoria=categoria_ativa.slug, calibre=c.id, marca=filtros.marca, preco_max=filtros.preco_max) }}" 
                               class="filter-link {{ 'active' if filtros.calibre == c.id else '' }}"
                               {% if filtros.calibre == c.id %}aria-current="true"{% endif %}>
                                {{ c.nome }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </aside>

        {# ÁREA DE PRODUTOS #}
        <div class="col-lg-9">
            {# HEADER DA LISTAGEM #}
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 border-bottom pb-3 gap-3">
                <h1 class="h4 fw-bold text-uppercase mb-0">{{ categoria_ativa.nome }}</h1>
                
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex align-items-center gap-2">
                        <label for="sort-select" class="small text-muted text-nowrap">Ordenar:</label>
                        <select id="sort-select" class="form-select form-select-sm border-0 shadow-sm" style="width: 160px;" onchange="location = this.value;">
                            <option value="{{ url_for('loja.categoria', slug_categoria=categoria_ativa.slug, sort='novidades') }}" {{ 'selected' if sort_atual == 'novidades' }}>Novidades</option>
                            <option value="{{ url_for('loja.categoria', slug_categoria=categoria_ativa.slug, sort='menor_preco') }}" {{ 'selected' if sort_atual == 'menor_preco' }}>Menor Preço</option>
                            <option value="{{ url_for('loja.categoria', slug_categoria=categoria_ativa.slug, sort='maior_preco') }}" {{ 'selected' if sort_atual == 'maior_preco' }}>Maior Preço</option>
                        </select>
                    </div>
                    <div class="text-muted small d-none d-md-block">| {{ pagination.total }} produtos</div>
                </div>
            </div>

            {% if produtos %}
            <div class="row row-cols-2 row-cols-md-3 g-3 g-lg-4">
                {% for produto in produtos %}
                    {% include 'loja/_card_produto.html' %}
                {% endfor %}
            </div>

            {# PAGINAÇÃO ESTILIZADA #}
            {% if pagination.pages > 1 %}
            <nav class="mt-5" aria-label="Navegação de páginas">
                <ul class="pagination justify-content-center">
                    {% for num in pagination.iter_pages() %}
                        {% if num %}
                        <li class="page-item">
                            <a class="page-link shadow-sm mx-1 {{ 'active-m4' if num == pagination.page else '' }}" 
                               href="{{ url_for('loja.categoria', slug_categoria=categoria_ativa.slug, page=num, sort=sort_atual, marca=filtros.marca, calibre=filtros.calibre, preco_max=filtros.preco_max) }}"
                               {% if num == pagination.page %}aria-current="page"{% endif %}>
                               {{ num }}
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center py-5 bg-white rounded border-0 shadow-sm">
                <i class="bi bi-funnel fs-1 text-muted opacity-25" aria-hidden="true"></i>
                <h2 class="mt-3 fw-bold h5">Nenhum resultado encontrado</h2>
                <p class="text-muted">Não encontramos produtos para esta combinação de filtros.</p>
                <a href="{{ url_for('loja.categoria', slug_categoria=categoria_ativa.slug) }}" class="btn btn-dark px-4 btn-sm">LIMPAR FILTROS</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* Sidebar Estilizada */
    .filter-title {
        font-family: 'Oswald', sans-serif;
        font-size: 0.9rem;
        letter-spacing: 1px;
        border-left: 3px solid var(--m4-gold);
        padding-left: 10px;
    }

    .filter-link {
        font-size: 0.8rem;
        color: #444; /* Melhorei o contraste de #666 para #444 */
        padding: 7px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: 0.2s;
        text-decoration: none !important;
    }

    .filter-link:hover {
        color: var(--m4-gold);
        padding-left: 5px;
    }

    .filter-link.active {
        color: var(--m4-gold);
        font-weight: 700;
    }

    .filter-count {
        font-size: 0.7rem;
        background: #f8f9fa;
        padding: 2px 8px;
        border-radius: 10px;
        color: #555; /* Melhorei o contraste de #999 para #555 */
    }

    /* Scrollbar Minimalista */
    .filter-scroll::-webkit-scrollbar { width: 3px; }
    .filter-scroll::-webkit-scrollbar-thumb { background: #eee; border-radius: 10px; }
    .filter-scroll:hover::-webkit-scrollbar-thumb { background: var(--m4-gold); }

    /* Paginação Customizada */
    .page-link {
        border: none !important;
        color: #333;
        font-weight: 600;
        background: #fff;
        padding: 8px 16px;
    }
    
    .active-m4 {
        background-color: var(--m4-gold) !important;
        color: #000 !important;
    }

    .breadcrumb-item + .breadcrumb-item::before { content: "›"; font-size: 1.2rem; line-height: 1; }
    .text-gold { color: var(--m4-gold) !important; }
</style>
{% endblock %}