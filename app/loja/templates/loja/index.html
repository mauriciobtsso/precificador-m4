{% extends 'loja/base.html' %}

{% block content %}
{# =============================================
   1. BANNER CARROSSEL (DINÂMICO PELO ADMIN)
   ============================================= #}
{% if not termo_busca and not categoria_ativa %}
    {% if banners %}
    <div id="heroCarousel" class="carousel slide carousel-fade mb-5" data-bs-ride="carousel">
        <div class="carousel-inner">
            {% for banner in banners %}
            <div class="carousel-item {{ 'active' if loop.first }}">
                {% set banner_link = gerar_link(banner.imagem_url) %}
                
                {# Definimos uma proporção padrão para armas/banners (geralmente 3:1 ou 1200x400) #}
                {% set img_attrs = 'class="d-block w-100" alt="' ~ banner.titulo ~ '" width="1200" height="400" style="object-fit: cover; aspect-ratio: 1200 / 400;" decoding="async"' %}
                
                {% if loop.first %}
                    {# O primeiro banner é o LCP: Prioridade máxima, sem lazy load #}
                    {% set img_attrs = img_attrs ~ ' fetchpriority="high"' %}
                {% else %}
                    {# Os demais banners usam lazy load para economizar banda #}
                    {% set img_attrs = img_attrs ~ ' loading="lazy"' %}
                {% endif %}

                {% if banner.link_destino %}
                    <a href="{{ banner.link_destino }}">
                        <img src="{{ banner_link }}" {{ img_attrs | safe }}>
                    </a>
                {% else %}
                    <img src="{{ banner_link }}" {{ img_attrs | safe }}>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% if banners|length > 1 %}
        <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
        <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
        {% endif %}
    </div>
    {% else %}
        <div class="py-5 bg-dark text-center mb-5">
            <p class="text-white opacity-50 m-0">Cadastre banners no painel administrativo.</p>
        </div>
    {% endif %}
{% endif %}

{# =============================================
   2. VITRINE DE MARCAS (LOGOS DINÂMICAS)
   ============================================= #}
{% if not termo_busca and not categoria_ativa %}
    {% set marcas_lista = marcas_home if marcas_home else marcas %}
    {% if marcas_lista %}
    <div class="container py-4 overflow-hidden">
        <div class="brands-slider">
            <div class="brands-track">
                {% for marca in marcas_lista %}
                <div class="brand-slide">
                    <a href="{{ url_for('loja.index', q=marca.nome) }}" class="brand-item text-decoration-none">
                        <div class="bg-white p-2 rounded shadow-sm border brand-card d-flex align-items-center justify-content-center" style="height: 80px;">
                            {% if marca.logo_url %}
                                <img src="{{ gerar_link(marca.logo_url) }}" alt="{{ marca.nome }}" class="img-fluid brand-img" loading="lazy" decoding="async">
                            {% else %}
                                <span class="fw-bold text-dark opacity-50">{{ marca.nome|upper }}</span>
                            {% endif %}
                        </div>
                    </a>
                </div>
                {% endfor %}
                
                {# Duplicamos para o efeito infinito #}
                {% for marca in marcas_lista %}
                <div class="brand-slide d-none d-md-block">
                    <a href="{{ url_for('loja.index', q=marca.nome) }}" class="brand-item text-decoration-none">
                        <div class="bg-white p-2 rounded shadow-sm border brand-card d-flex align-items-center justify-content-center" style="height: 80px;">
                            {% if marca.logo_url %}
                                <img src="{{ gerar_link(marca.logo_url) }}" alt="{{ marca.nome }}" class="img-fluid brand-img" loading="lazy" decoding="async">
                            {% else %}
                                <span class="fw-bold text-dark opacity-50">{{ marca.nome|upper }}</span>
                            {% endif %}
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <style>
        .brands-slider { width: 100%; position: relative; padding: 10px 0; }
        .brands-track { display: flex; gap: 20px; animation: scrollBrands 70s linear infinite; width: fit-content; }
        .brand-slide { width: 180px; flex-shrink: 0; }
        .brand-card { transition: 0.3s; border: 1px solid #eee !important; }
        .brand-img { max-height: 50px; max-width: 120px; filter: grayscale(100%); opacity: 0.6; transition: 0.3s; object-fit: contain; }
        .brand-card:hover { border-color: var(--m4-gold) !important; transform: translateY(-5px); }
        .brand-card:hover .brand-img { filter: grayscale(0%); opacity: 1; transform: scale(1.05); }
        @keyframes scrollBrands { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .brands-slider:hover .brands-track { animation-play-state: paused; }
    </style>
{% endif %}

<div class="container mt-5">
    {% if not termo_busca and not categoria_ativa %}
        
        {# 3. LANÇAMENTOS (Inteligente) #}
        {% if lancamentos %}
        <section class="mb-5">
            <div class="shelf-header">
                <h4 class="shelf-title">Lançamentos</h4>
                <span class="text-muted small ms-2">Novidades na armaria</span>
            </div>
            <div class="row row-cols-2 row-cols-md-4 g-4">
                {% for produto in lancamentos %}
                    {% include 'loja/_card_produto.html' %}
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {# 4. DESTAQUES DA SEMANA (Aleatórios) #}
        {% if destaques %}
        <section class="mb-5">
            <div class="shelf-header">
                <h4 class="shelf-title">Destaques da Semana</h4>
                <a href="#" class="shelf-link" onclick="window.location.reload(); return false;">
                    <i class="bi bi-arrow-clockwise me-1"></i>Ver Outros
                </a>
            </div>
            <div class="row row-cols-2 row-cols-md-4 g-4">
                {% for produto in destaques %}
                    {% include 'loja/_card_produto.html' %}
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {# 5. BANNER INSTITUCIONAL / DESPACHANTE (DINÂMICO) #}
        <section class="mb-5">
            <div class="promo-banner shadow-sm rounded overflow-hidden">
                <div class="p-5 bg-dark text-center position-relative" 
                     style="background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('{{ loja.banner_despachante_link }}') center/cover; min-height: 350px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    
                    <h2 class="text-gold fw-bold mb-2" style="letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                        {{ loja.lo_despachante_titulo if loja.loja_despachante_titulo else 'DESPACHANTE M4 TÁTICA' }}
                    </h2>
                    
                    <p class="text-white opacity-75 mb-4 mx-auto" style="max-width: 700px; font-size: 1.1rem;">
                        {{ loja.loja_despachante_texto if loja.loja_despachante_texto else 'Assessoria completa para aquisição legal de armas de fogo e CR.' }}
                    </p>
                    
                    <a href="https://wa.me/{{ loja.loja_whatsapp if loja.loja_whatsapp else '558630255885' }}" target="_blank" class="btn btn-gold fw-bold px-5 py-3 shadow">
                        <i class="bi bi-whatsapp me-2"></i> QUERO MINHA ARMA LEGALIZADA
                    </a>
                </div>
            </div>
        </section>

        {# 6. VITRINES DINÂMICAS POR CATEGORIA #}
        {% if prateleiras %}
            {% for nome_cat, prods in prateleiras.items() %}
                {% if prods %}
                <section class="mb-5">
                    <div class="shelf-header">
                        <h4 class="shelf-title">{{ nome_cat }}</h4>
                        {% set slug_temp = prods[0].categoria.slug if prods[0].categoria else nome_cat|lower %}
                        <a href="{{ url_for('loja.categoria', slug_categoria=slug_temp) }}" class="shelf-link">Ver Tudo</a>
                    </div>
                    <div class="row row-cols-2 row-cols-md-4 g-4">
                        {% for produto in prods %}
                            {% include 'loja/_card_produto.html' %}
                        {% endfor %}
                    </div>
                </section>
                {% endif %}
            {% endfor %}
        {% endif %}

    {% else %}
        {# VIEW DE BUSCA #}
        <div class="row mt-4">
            <div class="col-12">
                 <h2 class="h5 fw-bold text-uppercase mb-4">
                    {% if termo_busca %}Busca: <span class="text-gold">"{{ termo_busca }}"</span>
                    {% elif categoria_ativa %}Categoria: <span class="text-gold">{{ categoria_ativa.nome }}</span>
                    {% endif %}
                </h2>
                <div class="row row-cols-2 row-cols-md-4 g-4">
                    {% for produto in produtos %}
                        {% include 'loja/_card_produto.html' %}
                    {% endfor %}
                </div>
                
                {% if pagination and pagination.pages > 1 %}
                <nav class="mt-5"><ul class="pagination justify-content-center">
                    {% for num in pagination.iter_pages() %}{% if num %}
                    <li class="page-item {{ 'active' if num == pagination.page }}">
                        <a class="page-link border-0 text-dark" href="{{ url_for(request.endpoint, page=num, q=termo_busca, slug_categoria=categoria_ativa.slug if categoria_ativa else None) }}">{{ num }}</a>
                    </li>
                    {% endif %}{% endfor %}
                </ul></nav>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<style>
    .shelf-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 12px; }
    .shelf-title { font-weight: 800; text-transform: uppercase; font-size: 1.1rem; border-left: 5px solid var(--m4-gold); padding-left: 15px; margin: 0; letter-spacing: 0.5px; color: #1a1a1a; }
    .shelf-link { color: var(--m4-gold); font-size: 11px; font-weight: 800; text-transform: uppercase; text-decoration: none; transition: 0.3s; border: 1px solid var(--m4-gold); padding: 4px 12px; border-radius: 20px; }
    .shelf-link:hover { background: var(--m4-gold); color: #000; }
    .promo-banner .btn-gold { background-color: var(--m4-gold); border-color: var(--m4-gold); color: #000; transition: 0.3s; }
    .promo-banner .btn-gold:hover { background-color: #fff; border-color: #fff; transform: scale(1.05); }
    .text-gold { color: var(--m4-gold) !important; }
</style>
{% endblock %}