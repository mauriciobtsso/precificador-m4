{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
  <h2 class="fw-semibold text-dark mb-0">
    <i class="fas fa-shopping-bag text-danger me-2"></i> Vendas
  </h2>
  <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-dark btn-sm rounded-pill px-3">
    <i class="fas fa-home me-1"></i> Dashboard
  </a>
</div>

<!-- =============================
     FILTROS
============================= -->
<form method="get" class="row g-2 mb-3">
  <!-- Cliente -->
  <div class="col-12 col-md-3">
    <input type="text" name="cliente" value="{{ request.args.get('cliente','') }}"
           class="form-control" placeholder="Cliente">
  </div>

  <!-- Status -->
  <div class="col-6 col-md-2">
    <select name="status" class="form-select">
      <option value="">Todos os Status</option>
      <option value="aberta"    {% if request.args.get('status')=='aberta' %}selected{% endif %}>Aberta</option>
      <option value="fechada"   {% if request.args.get('status')=='fechada' %}selected{% endif %}>Fechada</option>
      <option value="quitada"   {% if request.args.get('status')=='quitada' %}selected{% endif %}>Quitada</option>
      <option value="devolução" {% if request.args.get('status')=='devolução' %}selected{% endif %}>Devolução</option>
    </select>
  </div>

  <!-- Período -->
  <div class="col-6 col-md-2">
    <select name="periodo" class="form-select" id="filtro-periodo">
      <option value="">Todos os períodos</option>
      <option value="7d"           {% if request.args.get('periodo')=='7d' %}selected{% endif %}>Últimos 7 dias</option>
      <option value="mes"          {% if request.args.get('periodo')=='mes' %}selected{% endif %}>Mês atual</option>
      <option value="personalizado"{% if request.args.get('periodo')=='personalizado' %}selected{% endif %}>Personalizado</option>
    </select>
  </div>

  <!-- Intervalo de datas -->
  <div class="col-6 col-md-2 d-none" id="campo-inicio">
    <input type="date" name="data_inicio" value="{{ request.args.get('data_inicio','') }}" class="form-control">
  </div>
  <div class="col-6 col-md-2 d-none" id="campo-fim">
    <input type="date" name="data_fim" value="{{ request.args.get('data_fim','') }}" class="form-control">
  </div>

  <!-- Botões -->
  <div class="col-6 col-md-1">
    <button type="submit" class="btn btn-primary w-100">
      <i class="fas fa-search"></i>
    </button>
  </div>
  <div class="col-6 col-md-1">
    <a href="{{ url_for('vendas.vendas') }}" class="btn btn-outline-secondary w-100">
      <i class="fas fa-eraser"></i>
    </a>
  </div>
</form>

<!-- =============================
     LISTAGEM (DESKTOP)
============================= -->
<div class="d-none d-md-block">
  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 80px;">ID</th>
            <th>Cliente</th>
            <th style="width: 200px;">Data</th>
            <th style="width: 180px;">Valor Total</th>
            <th style="width: 160px;">Status</th>
            <th style="width: 140px;" class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for venda in vendas.items %}
          <tr>
            <td>#{{ venda.id }}</td>
            <td>{{ venda.cliente.nome if venda.cliente else "Não identificado" }}</td>
            <td>{{ venda.data_abertura.strftime("%d/%m/%Y %H:%M") if venda.data_abertura else "-" }}</td>
            <td>{{ venda.valor_total|currency }}</td>
            <td>{{ venda.status or "-" }}</td>
            <td class="text-end">
              <a href="{{ url_for('vendas.venda_detalhe', venda_id=venda.id) }}"
                 class="btn btn-sm btn-primary rounded-pill px-3">
                <i class="fas fa-eye me-1"></i> Detalhes
              </a>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">Nenhuma venda encontrada.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- =============================
     LISTAGEM (MOBILE)
============================= -->
<div class="d-md-none">
  {% for venda in vendas.items %}
  <div class="card shadow-sm border-0 mb-3 rounded-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-bold">#{{ venda.id }} • {{ venda.cliente.nome if venda.cliente else "Não identificado" }}</div>
          <small class="text-muted">
            {{ venda.data_abertura.strftime("%d/%m/%Y %H:%M") if venda.data_abertura else "-" }}
          </small>
        </div>
        <span class="badge
          {% if (venda.status or '').lower().startswith('aber') %} bg-warning text-dark
          {% elif (venda.status or '').lower().startswith('fech') %} bg-secondary
          {% elif (venda.status or '').lower().startswith('quit') %} bg-success
          {% elif 'devol' in (venda.status or '').lower() %} bg-danger
          {% else %} bg-info
          {% endif %}">
          {{ venda.status or "-" }}
        </span>
      </div>

      <div class="mt-2">
        <div class="text-muted small">Valor total</div>
        <div class="fs-6 fw-semibold">{{ venda.valor_total|currency }}</div>
      </div>

      <div class="mt-3 d-flex justify-content-end">
        <a href="{{ url_for('vendas.venda_detalhe', venda_id=venda.id) }}" class="btn btn-primary btn-sm rounded-pill px-3">
          <i class="fas fa-eye me-1"></i> Ver detalhes
        </a>
      </div>
    </div>
  </div>
  {% else %}
  <div class="text-center text-muted">Nenhuma venda encontrada.</div>
  {% endfor %}
</div>

<!-- =============================
     PAGINAÇÃO
============================= -->
{% if vendas.pages > 1 %}
<nav aria-label="Paginação" class="mt-4">
  <ul class="pagination justify-content-center mb-0">
    {% if vendas.has_prev %}
      <li class="page-item">
        <a class="page-link" href="?page={{ vendas.prev_num }}">&laquo; Anterior</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo; Anterior</span></li>
    {% endif %}

    {% for p in range(1, vendas.pages + 1) %}
      <li class="page-item {% if p == vendas.page %}active{% endif %}">
        <a class="page-link" href="?page={{ p }}">{{ p }}</a>
      </li>
    {% endfor %}

    {% if vendas.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ vendas.next_num }}">Próxima &raquo;</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Próxima &raquo;</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- =============================
     SCRIPT: CAMPOS DE PERÍODO
============================= -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const selectPeriodo = document.getElementById("filtro-periodo");
  const campoInicio = document.getElementById("campo-inicio");
  const campoFim = document.getElementById("campo-fim");

  function toggleCampos() {
    if (selectPeriodo.value === "personalizado") {
      campoInicio.classList.remove("d-none");
      campoFim.classList.remove("d-none");
    } else {
      campoInicio.classList.add("d-none");
      campoFim.classList.add("d-none");
    }
  }
  selectPeriodo.addEventListener("change", toggleCampos);
  toggleCampos();
});
</script>
{% endblock %}
