{% extends "base.html" %}

{% block content %}

<style>
    /* Estilos do Processo */
    .step-indicator { display: flex; justify-content: space-between; list-style: none; padding: 0; margin-bottom: 2rem; }
    .step-indicator li { flex: 1; position: relative; text-align: center; font-size: 0.75rem; font-weight: 600; color: #adb5bd; }
    .step-indicator li:before { content: counter(step); counter-increment: step; width: 30px; height: 30px; line-height: 28px; border: 2px solid #e9ecef; display: block; text-align: center; margin: 0 auto 10px auto; border-radius: 50%; background-color: #fff; color: #adb5bd; }
    .step-indicator li:after { content: ""; position: absolute; width: 100%; height: 2px; background-color: #e9ecef; top: 15px; left: -50%; z-index: -1; }
    .step-indicator li:first-child:after { content: none; }
    .step-indicator li.active { color: #0d6efd; }
    .step-indicator li.active:before { border-color: #0d6efd; background-color: #0d6efd; color: #fff; }
    .step-indicator li.completed { color: #198754; }
    .step-indicator li.completed:before { border-color: #198754; background-color: #198754; color: #fff; content: "✔"; }
    .step-indicator li.completed:after { background-color: #198754; }
    .card-processo { border-left: 4px solid #e9ecef; transition: all 0.2s; }
    .card-processo.active { border-left-color: #0d6efd; background-color: #f8f9fa; }
    .card-processo.done { border-left-color: #198754; opacity: 0.8; }
</style>

{% set tipo_venda = venda.tipo_processo %} 
{% set etapa_atual = venda.etapa or 'RASCUNHO' %}

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold text-dark mb-0">
                <i class="fas fa-file-invoice text-primary me-2"></i>Venda #{{ venda.id }}
            </h4>
            <small class="text-muted">
                Tipo: <strong class="text-uppercase">{{ tipo_venda }}</strong> | 
                Vendedor: <strong>{{ venda.vendedor }}</strong>
            </small>
        </div>
        <div class="d-flex gap-2">
            {% if venda.status != 'cancelado' %}
                <div class="dropdown d-inline-block">
                    <button class="btn btn-outline-dark btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-file-alt me-1"></i> Gerar Documento
                    </button>
                    <ul class="dropdown-menu shadow">
                        <li><h6 class="dropdown-header">Modelos Disponíveis</h6></li>
                        
                        {% if tipo_venda == 'arma' %}
                            <li><a class="dropdown-item" target="_blank" href="{{ url_for('vendas.gerar_documento', venda_id=venda.id, chave='contrato_arma') }}"><i class="fas fa-file-contract me-2"></i> Contrato Venda Arma</a></li>
                            <li><a class="dropdown-item" target="_blank" href="{{ url_for('vendas.gerar_documento', venda_id=venda.id, chave='servico_despachante') }}"><i class="fas fa-file-signature me-2"></i> Contrato Despachante</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" target="_blank" href="{{ url_for('vendas.gerar_documento', venda_id=venda.id, chave='retirada_arma') }}"><i class="fas fa-shipping-fast me-2"></i> Termo Retirada Arma</a></li>
                        
                        {% elif tipo_venda == 'municao' %}
                            <li><a class="dropdown-item" target="_blank" href="{{ url_for('vendas.gerar_documento', venda_id=venda.id, chave='retirada_municao') }}"><i class="fas fa-box-open me-2"></i> Termo Retirada Munição</a></li>
                        
                        {% else %}
                            <li><a class="dropdown-item disabled" href="#">Venda Livre (Recibo Comum)</a></li>
                        {% endif %}
                    </ul>
                </div>

                <button class="btn btn-outline-danger btn-sm" onclick="cancelarVenda({{ venda.id }})">
                    <i class="fas fa-ban me-1"></i> Cancelar
                </button>
                <button class="btn btn-success btn-sm">
                    <i class="fas fa-save me-1"></i> Salvar
                </button>
            {% else %}
                <span class="badge bg-danger">CANCELADA</span>
            {% endif %}
            <a href="{{ url_for('vendas.vendas') }}" class="btn btn-secondary btn-sm">Voltar</a>
        </div>
    </div>

    <ul class="step-indicator">
        <li class="completed">Abertura</li>
        
        {% if tipo_venda == 'arma' %}
            <li class="{% if etapa_atual != 'RASCUNHO' %}active{% endif %}">Contrato/NF</li>
            <li>Autorização</li>
            <li>Registro (CRAF)</li>
            <li>GT / Tráfego</li>
        {% else %}
            <li class="{% if etapa_atual != 'RASCUNHO' %}completed{% endif %}">NF / Validação</li>
        {% endif %}
        
        <li>Entrega</li>
    </ul>

    <div class="row">
        <div class="col-lg-8">
            
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">1. Itens do Pedido</h6>
                    <span class="badge bg-light text-dark">{{ venda.qtd_total_itens }} itens</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0 align-middle">
                            <thead class="table-light small">
                                <tr>
                                    <th>Produto</th>
                                    <th>Rastreio / Origem</th>
                                    <th class="text-center">Qtd</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in venda.itens %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ item.produto_nome }}</div>
                                        <small class="text-muted">{{ item.categoria or 'Produto' }}</small>
                                    </td>
                                    <td>
                                        {% if item.item_estoque_id %}
                                            <span class="badge bg-info text-dark" title="Item reservado do estoque">
                                                <i class="fas fa-barcode me-1"></i> {{ item.item_estoque.numero_serie or item.item_estoque.lote }}
                                            </span>
                                        {% endif %}
                                        
                                        {% if item.arma_cliente %}
                                            <div class="mt-1 small text-success">
                                                <i class="fas fa-link me-1"></i> Vinculado à: {{ item.arma_cliente.descricao_curta or item.arma_cliente.numero_serie }}
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ item.quantidade }}</td>
                                    <td class="text-end">{{ item.valor_total|currency }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-danger"><i class="fas fa-balance-scale me-2"></i>Processo Legal</h6>
                </div>
                <div class="card-body">
                    
                    {% if tipo_venda == 'arma' %}
                    <div class="card card-processo mb-3">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-1">Contrato de Compra e Venda</h6>
                                <small class="text-muted">Gerar minuta e anexar via assinada.</small>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('vendas.gerar_documento', venda_id=venda.id, chave='contrato_arma') }}" target="_blank" class="btn btn-sm btn-light border"><i class="fas fa-print me-1"></i> Gerar</a>
                                <button onclick="abrirModalUpload('contrato', 'Contrato Assinado')" class="btn btn-sm btn-outline-primary"><i class="fas fa-upload me-1"></i> Anexar</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="card card-processo mb-3">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-1">Nota Fiscal (NF-e)</h6>
                                <small class="text-muted">Obrigatório para baixa de estoque.</small>
                            </div>
                            <div class="d-flex gap-2">
                                <span class="badge bg-secondary align-self-center">Pendente</span>
                                <button class="btn btn-sm btn-outline-dark"><i class="fas fa-file-invoice-dollar me-1"></i> Emitir</button>
                            </div>
                        </div>
                    </div>

                    {% if tipo_venda == 'arma' %}
                    <div class="card card-processo mb-3">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-1">Autorização de Compra</h6>
                                <small class="text-muted">SisGCorp / Sinarm.</small>
                            </div>
                            <div>
                                <button onclick="abrirModalUpload('autorizacao', 'Autorização de Compra')" class="btn btn-sm btn-primary"><i class="fas fa-file-upload me-1"></i> Anexar</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="card card-processo mb-3">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-1">Certificado de Registro (CRAF)</h6>
                                {% if tipo_venda == 'municao' %}
                                    <small class="text-success"><i class="fas fa-check me-1"></i> Vinculado do Cliente:</small>
                                    {% for item in venda.itens if item.arma_cliente %}
                                        <div class="small mt-1 text-muted ms-3">
                                            • {{ item.arma_cliente.tipo }} {{ item.arma_cliente.calibre }} - {{ item.arma_cliente.numero_serie }}
                                        </div>
                                    {% else %}
                                        <div class="small text-danger">Nenhuma arma vinculada nos itens!</div>
                                    {% endfor %}
                                {% else %}
                                    <small class="text-muted">Aguardando emissão pelo órgão.</small>
                                {% endif %}
                            </div>
                            <div>
                                {% if tipo_venda == 'municao' %}
                                    {% for item in venda.itens if item.arma_cliente and item.arma_cliente.caminho_craf %}
                                        <a href="{{ url_for('main.imagem_proxy', key=item.arma_cliente.caminho_craf) }}" target="_blank" class="btn btn-sm btn-info text-white mb-1">
                                            <i class="fas fa-eye me-1"></i> Ver CRAF
                                        </a>
                                    {% endfor %}
                                {% else %}
                                    <button onclick="abrirModalUpload('craf', 'CRAF (Novo)')" class="btn btn-sm btn-primary"><i class="fas fa-file-upload me-1"></i> Anexar CRAF</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="card card-processo done mb-3">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-1">Entrega / Termo de Retirada</h6>
                                <small class="text-success"><i class="fas fa-check-circle me-1"></i> Liberado para entrega</small>
                            </div>
                            <div class="d-flex gap-2">
                                {% if tipo_venda == 'municao' %}
                                    <a href="{{ url_for('vendas.gerar_documento', venda_id=venda.id, chave='retirada_municao') }}" target="_blank" class="btn btn-sm btn-light border">
                                        <i class="fas fa-print me-1"></i> Imprimir Termo
                                    </a>
                                {% elif tipo_venda == 'arma' %}
                                    <a href="{{ url_for('vendas.gerar_documento', venda_id=venda.id, chave='retirada_arma') }}" target="_blank" class="btn btn-sm btn-light border">
                                        <i class="fas fa-print me-1"></i> Imprimir Termo
                                    </a>
                                {% endif %}
                                
                                <button onclick="abrirModalUpload('termo_assinado', 'Termo Assinado')" class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-upload me-1"></i> Anexar Assinado
                                </button>
                                
                                <button class="btn btn-sm btn-success"><i class="fas fa-check me-1"></i> Concluir</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>

        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-secondary">Cliente</h6>
                </div>
                <div class="card-body">
                    <h5 class="fw-bold mb-1">{{ venda.cliente_nome or venda.cliente.nome }}</h5>
                    <p class="text-muted small mb-3">
                        CPF/CNPJ: {{ venda.documento_cliente or venda.cliente.documento }}<br>
                        CR: {{ venda.cliente.cr or 'Não informado' }}
                    </p>
                    <div class="d-grid">
                        <a href="{{ url_for('clientes.detalhe', cliente_id=venda.cliente_id) }}" target="_blank" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-user me-1"></i> Ver Cadastro Completo
                        </a>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-secondary">Arquivos da Venda</h6>
                </div>
                <ul class="list-group list-group-flush small">
                    {% for anexo in venda.anexos %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="far fa-file-pdf text-danger me-2"></i> {{ anexo.tipo_documento|replace('_', ' ')|title }}
                            <br><span class="text-muted x-small">{{ anexo.criado_em|dt_local }}</span>
                        </div>
                        <a href="{{ url_for('main.imagem_proxy', key=anexo.url_arquivo) }}" target="_blank" class="text-primary"><i class="fas fa-download"></i></a>
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted text-center py-3">Nenhum anexo ainda.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalUploadAnexo" tabindex="-1">
    <div class="modal-dialog">
        <form method="POST" action="{{ url_for('vendas.upload_anexo', venda_id=venda.id) }}" enctype="multipart/form-data" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Anexar Documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="tipo_documento" id="uploadTipoDoc">
                <p class="mb-3">Enviando: <strong id="uploadNomeDoc"></strong></p>
                
                <label class="form-label">Selecione o arquivo (PDF ou Imagem)</label>
                <input type="file" name="arquivo" class="form-control" required accept="application/pdf,image/*">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Enviar</button>
            </div>
        </form>
    </div>
</div>

<script>
function abrirModalUpload(tipo, nomeAmigavel) {
    document.getElementById('uploadTipoDoc').value = tipo;
    document.getElementById('uploadNomeDoc').textContent = nomeAmigavel;
    new bootstrap.Modal(document.getElementById('modalUploadAnexo')).show();
}

function cancelarVenda(id) {
    if(confirm("Tem certeza que deseja cancelar esta venda? O estoque será estornado.")) {
        alert("Funcionalidade será implementada no próximo passo!");
    }
}
</script>

{% endblock %}