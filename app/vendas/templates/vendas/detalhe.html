{% extends "base.html" %}

{% block content %}

<style>
    .step-indicator {
        display: flex;
        justify-content: space-between;
        list-style: none;
        padding: 0;
        margin-bottom: 2rem;
    }
    .step-indicator li {
        flex: 1;
        position: relative;
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #adb5bd;
    }
    .step-indicator li:before {
        content: counter(step);
        counter-increment: step;
        width: 30px;
        height: 30px;
        line-height: 28px;
        border: 2px solid #e9ecef;
        display: block;
        text-align: center;
        margin: 0 auto 10px auto;
        border-radius: 50%;
        background-color: #fff;
        color: #adb5bd;
    }
    .step-indicator li:after {
        content: "";
        position: absolute;
        width: 100%;
        height: 2px;
        background-color: #e9ecef;
        top: 15px;
        left: -50%;
        z-index: -1;
    }
    .step-indicator li:first-child:after { content: none; }
    
    /* Ativo / Concluído */
    .step-indicator li.active { color: #0d6efd; }
    .step-indicator li.active:before { border-color: #0d6efd; background-color: #0d6efd; color: #fff; }
    .step-indicator li.completed { color: #198754; }
    .step-indicator li.completed:before { border-color: #198754; background-color: #198754; color: #fff; content: "✔"; }
    .step-indicator li.completed:after { background-color: #198754; }

    /* Cards de Processo */
    .card-processo { border-left: 4px solid #e9ecef; transition: all 0.2s; }
    .card-processo.active { border-left-color: #0d6efd; background-color: #f8f9fa; }
    .card-processo.done { border-left-color: #198754; opacity: 0.8; }
</style>

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold text-dark mb-0">
                <i class="fas fa-file-invoice text-primary me-2"></i>Venda #{{ venda.id }}
            </h4>
            <small class="text-muted">Aberta em {{ venda.data_abertura|dt_local }} por <strong>{{ venda.vendedor }}</strong></small>
        </div>
        <div class="d-flex gap-2">
            {% if venda.status != 'cancelado' %}
                <button class="btn btn-outline-danger btn-sm" onclick="cancelarVenda({{ venda.id }})">
                    <i class="fas fa-ban me-1"></i> Cancelar
                </button>
                <button class="btn btn-success btn-sm">
                    <i class="fas fa-save me-1"></i> Salvar Alterações
                </button>
            {% else %}
                <span class="badge bg-danger">CANCELADA</span>
            {% endif %}
            <a href="{{ url_for('vendas.vendas') }}" class="btn btn-secondary btn-sm">Voltar</a>
        </div>
    </div>

    {% set etapa_atual = venda.etapa or 'RASCUNHO' %}
    <ul class="step-indicator">
        <li class="{% if etapa_atual in ['ABERTA','ASSINATURA','AUTORIZACAO','CRAF','GT','RETIRADA','CONCLUIDA'] %}completed{% else %}active{% endif %}">Abertura</li>
        <li class="{% if etapa_atual in ['ASSINATURA','AUTORIZACAO','CRAF','GT','RETIRADA','CONCLUIDA'] %}completed{% elif etapa_atual == 'RASCUNHO' %} {% else %}active{% endif %}">Contrato/NF</li>
        <li class="{% if etapa_atual in ['AUTORIZACAO','CRAF','GT','RETIRADA','CONCLUIDA'] %}completed{% endif %}">Autorização</li>
        <li class="{% if etapa_atual in ['CRAF','GT','RETIRADA','CONCLUIDA'] %}completed{% endif %}">Registro (CRAF)</li>
        <li class="{% if etapa_atual in ['GT','RETIRADA','CONCLUIDA'] %}completed{% endif %}">GT / Tráfego</li>
        <li class="{% if etapa_atual in ['RETIRADA','CONCLUIDA'] %}completed{% endif %}">Entrega</li>
    </ul>

    <div class="row">
        <div class="col-lg-8">
            
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">1. Itens do Pedido</h6>
                    <span class="badge bg-light text-dark">{{ venda.qtd_total_itens }} itens</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0 align-middle">
                            <thead class="table-light small">
                                <tr>
                                    <th>Produto</th>
                                    <th>Serial / Lote</th>
                                    <th class="text-center">Qtd</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in itens %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ item.produto_nome }}</div>
                                        <small class="text-muted">{{ item.categoria or 'Produto' }}</small>
                                    </td>
                                    <td>
                                        {% if item.item_estoque_id %}
                                            <span class="badge bg-info text-dark">
                                                <i class="fas fa-barcode me-1"></i> {{ item.item_estoque.numero_serie }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">Encomenda</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ item.quantidade }}</td>
                                    <td class="text-end">{{ item.valor_total|currency }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-danger"><i class="fas fa-balance-scale me-2"></i>Processo Legal</h6>
                </div>
                <div class="card-body">
                    
                    <div class="card card-processo mb-3 {% if etapa_atual == 'ASSINATURA' %}active{% endif %}">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-1">Contrato de Compra e Venda</h6>
                                <small class="text-muted">Gerar minuta e anexar via assinada.</small>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="#" class="btn btn-sm btn-light border"><i class="fas fa-print me-1"></i> Gerar PDF</a>
                                <button class="btn btn-sm btn-outline-primary"><i class="fas fa-upload me-1"></i> Anexar Assinado</button>
                            </div>
                        </div>
                    </div>

                    <div class="card card-processo mb-3">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-1">Nota Fiscal (NF-e)</h6>
                                <small class="text-muted">Simples faturamento ou Entrega Futura.</small>
                            </div>
                            <div class="d-flex gap-2">
                                <span class="badge bg-secondary align-self-center">Pendente</span>
                                <button class="btn btn-sm btn-outline-dark"><i class="fas fa-file-invoice-dollar me-1"></i> Emitir</button>
                            </div>
                        </div>
                    </div>

                    <div class="card card-processo mb-3">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-1">Autorização de Compra</h6>
                                <small class="text-muted">SisGCorp / Sinarm. O sistema lerá o QR Code.</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-primary"><i class="fas fa-file-upload me-1"></i> Anexar PDF</button>
                            </div>
                        </div>
                    </div>

                    <div class="card card-processo mb-3">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-1">Certificado de Registro (CRAF)</h6>
                                <small class="text-muted">Registro da arma no nome do cliente.</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-primary"><i class="fas fa-file-upload me-1"></i> Anexar PDF</button>
                            </div>
                        </div>
                    </div>

                    <div class="card card-processo done mb-3">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-1">Entrega / Termo de Retirada</h6>
                                <small class="text-success"><i class="fas fa-check-circle me-1"></i> Liberado para entrega</small>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="#" class="btn btn-sm btn-light border"><i class="fas fa-print me-1"></i> Imprimir Termo</a>
                                <button class="btn btn-sm btn-success"><i class="fas fa-check me-1"></i> Concluir Venda</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>

        <div class="col-lg-4">
            
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-secondary">Cliente</h6>
                </div>
                <div class="card-body">
                    <h5 class="fw-bold mb-1">{{ venda.cliente_nome or venda.cliente.nome }}</h5>
                    <p class="text-muted small mb-3">
                        CPF/CNPJ: {{ venda.documento_cliente or venda.cliente.documento }}<br>
                        CR: {{ venda.cliente.cr_numero or 'Não informado' }}
                    </p>
                    <div class="d-grid">
                        <a href="{{ url_for('clientes.editar_cliente', cliente_id=venda.cliente_id) }}" target="_blank" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-user me-1"></i> Ver Cadastro Completo
                        </a>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4 border-left-success">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">Financeiro</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Venda:</span>
                        <strong>{{ venda.valor_total|currency }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-success">
                        <span>Recebido:</span>
                        <strong>{{ venda.valor_recebido|currency }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-3 text-danger">
                        <span>Pendente:</span>
                        <strong>{{ venda.valor_faltante|currency }}</strong>
                    </div>
                    
                    <hr>
                    
                    <h6 class="small fw-bold mb-2">Parcelamento</h6>
                    {% if venda.crediario %}
                        <div class="alert alert-light border small mb-0">
                            {{ venda.parcelas_qtd }}x Parcelas (Vence dia {{ venda.parcelas_primeiro_vencimento }})
                        </div>
                    {% else %}
                        <p class="small text-muted">Pagamento à vista / Cartão externo.</p>
                    {% endif %}

                    <div class="d-grid mt-3">
                        <button class="btn btn-success btn-sm">
                            <i class="fas fa-dollar-sign me-1"></i> Lançar Pagamento
                        </button>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-secondary">Arquivos da Venda</h6>
                </div>
                <ul class="list-group list-group-flush small">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div><i class="far fa-file-pdf text-danger me-2"></i> Contrato Assinado</div>
                        <a href="#" class="text-primary"><i class="fas fa-download"></i></a>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div><i class="far fa-file-pdf text-danger me-2"></i> Autorização Compra</div>
                        <a href="#" class="text-primary"><i class="fas fa-download"></i></a>
                    </li>
                </ul>
            </div>

        </div>
    </div>
</div>

<script>
function cancelarVenda(id) {
    if(confirm("Tem certeza que deseja cancelar esta venda? O estoque será estornado.")) {
        // Chamar API de cancelamento aqui
        alert("Funcionalidade será implementada no próximo passo!");
    }
}
</script>

{% endblock %}