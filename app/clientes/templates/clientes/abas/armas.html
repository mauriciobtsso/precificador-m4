{# clientes/abas/armas.html #}
<h5>Armas do Cliente</h5>

<div class="mb-3">
  <!-- Botão Nova Arma -->
  <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalNovaArma">
    + Nova Arma
  </button>
</div>

<!-- Lista -->
<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Marca</th>
        <th>Modelo</th>
        <th>Calibre</th>
        <th>Nº Série</th>
        <th>Nº Reg. CRAF</th>
        <th>Validade CRAF</th>
        <th>Arquivo</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for arma in cliente.armas %}
      <tr>
        <td>{{ arma.tipo or "-" }}</td>
        <td>{{ arma.marca or "-" }}</td>
        <td>{{ arma.modelo or "-" }}</td>
        <td>{{ arma.calibre or "-" }}</td>
        <td>{{ arma.numero_serie or "-" }}</td>
        <td>{{ arma.numero_sigma or arma.craf or "-" }}</td>
        <td>
          {% if arma.validade_indeterminada %}
            Indeterminada
          {% else %}
            {{ arma.data_validade_craf.strftime("%d/%m/%Y") if arma.data_validade_craf else "-" }}
          {% endif %}
        </td>
        <td>
          {% if arma.caminho_craf %}
            <a href="{{ url_for('clientes.abrir_craf', arma_id=arma.id) }}" target="_blank"
               class="btn btn-sm btn-outline-primary">Abrir</a>
          {% else %}
            <span class="text-muted">Não enviado</span>
          {% endif %}
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-warning"
                  data-bs-toggle="modal" data-bs-target="#modalEditarArma{{ arma.id }}">
            Editar
          </button>

          <form method="POST"
                action="{{ url_for('clientes.deletar_arma', cliente_id=cliente.id, arma_id=arma.id) }}"
                style="display:inline;">
            <button type="submit" class="btn btn-sm btn-danger"
                    onclick="return confirm('Deseja realmente excluir esta arma?')">
              Excluir
            </button>
          </form>
        </td>
      </tr>

      {% include "clientes/abas/armas_editar.html" %}
      {% else %}
      <tr>
        <td colspan="9" class="text-center text-muted">Nenhuma arma cadastrada.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<hr>

<div class="row">
  <!-- Upload de CRAF com OCR -->
  <div class="col-md-6">
    <h6>Upload do CRAF (PDF/Imagem)</h6>
    <form id="formUploadCraf" data-cliente-id="{{ cliente.id }}" enctype="multipart/form-data" method="POST">
      <div class="mb-3">
        <input type="file" name="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required>
      </div>
      <button type="submit" class="btn btn-primary">Enviar e Processar CRAF</button>
    </form>
  </div>
</div>

<!-- Modal Nova Arma -->
{% include "clientes/abas/armas_nova.html" %}

<!-- Modal Pré-visualização CRAF (pós-OCR) -->
<div class="modal" id="preverCrafModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- ✅ ID essencial para o JS; sem data-ajax-save para submit normal -->
      <form id="formPreverCraf"
            method="POST"
            action="{{ url_for('clientes.salvar_craf', cliente_id=cliente.id) }}"
            novalidate
            autocomplete="off">

        <div class="modal-header">
          <h5 class="modal-title">Pré-visualizar CRAF</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <!-- Tipo -->
          <div class="mb-3">
            <label for="crafTipo" class="form-label">Tipo da Arma</label>
            <select name="tipo" id="crafTipo" class="form-select">
              <option value="">Selecione</option>
              {% for val, label in tipos_arma %}
                <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Calibre + Funcionamento -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="crafCalibre" class="form-label">Calibre</label>
              <input type="text" name="calibre" id="crafCalibre" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label for="crafFuncionamento" class="form-label">Funcionamento</label>
              <select name="funcionamento" id="crafFuncionamento" class="form-select">
                <option value="">Selecione</option>
                {% for val, label in funcionamento_arma %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Marca + Modelo -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="crafMarca" class="form-label">Marca</label>
              <input type="text" name="marca" id="crafMarca" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label for="crafModelo" class="form-label">Modelo</label>
              <input type="text" name="modelo" id="crafModelo" class="form-control" placeholder="(opcional)">
            </div>
          </div>

          <!-- Nº Série + Emissor + Nº Sigma -->
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="crafNumeroSerie" class="form-label">Número de Série</label>
              <input type="text" name="numero_serie" id="crafNumeroSerie" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
              <label for="crafEmissor" class="form-label">Emissor CRAF</label>
              <select name="emissor_craf" id="crafEmissor" class="form-select">
                <option value="">Selecione</option>
                {% for val, label in emissores_craf %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="crafSigma" class="form-label">Nº Sigma / Nº do Registro</label>
              <input type="text" name="numero_sigma" id="crafSigma" class="form-control">
            </div>
          </div>

          <!-- Validade + Categoria -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="crafValidade" class="form-label">Data de Validade</label>
              <input type="date" name="data_validade_craf" id="crafValidade" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label for="crafCategoria" class="form-label">Categoria do Adquirente</label>
              <select name="categoria_adquirente" id="crafCategoria" class="form-select">
                <option value="">Selecione</option>
                {% for val, label in categorias_adquirente %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Checkbox de validade indeterminada -->
          <div class="form-check mb-3">
            <input type="checkbox"
                   name="validade_indeterminada"
                   id="crafValidadeIndet"
                   class="form-check-input">
            <label class="form-check-label" for="crafValidadeIndet">
              A validade do CRAF é indeterminada
            </label>
          </div>

          <input type="hidden" name="caminho_craf" id="crafCaminho">
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Salvar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Importa o JS principal do módulo Armas -->
<script src="{{ url_for('static', filename='js/armas.js') }}"></script>
