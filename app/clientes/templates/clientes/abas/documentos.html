<!-- ====================== -->
<!-- ABA: DOCUMENTOS (NOVA) -->
<!-- ====================== -->

<div class="card shadow-sm mb-4">
  <div class="card-header d-flex justify-content-between align-items-center bg-white border-bottom">
    <h5 class="mb-0">
      <i class="fas fa-file-alt me-2 text-primary"></i> Documentos
    </h5>
    <div>
      <!-- Botão Novo Documento -->
      <button class="btn btn-sm btn-primary me-2"
              data-bs-toggle="modal"
              data-bs-target="#modalNovoDocumento">
        <i class="fas fa-plus me-1"></i> Novo Documento
      </button>

      <!-- Botão OCR -->
      <button class="btn btn-sm btn-success" id="btnUploadOCR">
        <i class="fas fa-upload me-1"></i> Enviar e Processar Documento (OCR)
      </button>

      <!-- Input oculto para upload -->
      <input type="file" id="inputUploadOCR" class="d-none" accept="application/pdf,image/*">
    </div>
  </div>

  <div class="card-body">
    <!-- Lista de documentos -->
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 15%">Categoria</th>
            <th style="width: 15%">Emissor</th>
            <th style="width: 15%">Nº Documento</th>
            <th style="width: 10%">Emissão</th>
            <th style="width: 10%">Validade</th>
            <th style="width: 20%">Arquivo</th>
            <th style="width: 15%" class="text-center">Ações</th>
          </tr>
        </thead>

        <tbody>
          {% for doc in cliente.documentos %}
          <tr>
            <!-- Categoria -->
            <td>{{ doc.categoria or doc.tipo or '-' }}</td>

            <!-- Emissor -->
            <td>{{ doc.emissor or '-' }}</td>

            <!-- Nº Documento -->
            <td>{{ doc.numero_documento or '-' }}</td>

            <!-- Data Emissão -->
            <td>
              {% if doc.data_emissao %}
                {{ doc.data_emissao.strftime('%d/%m/%Y') }}
              {% else %}
                -
              {% endif %}
            </td>

            <!-- Validade -->
            <td>
              {% if doc.validade_indeterminada %}
                <span class="badge bg-secondary">Indeterminada</span>
              {% elif doc.data_validade %}
                {{ doc.data_validade.strftime('%d/%m/%Y') }}
              {% else %}
                -
              {% endif %}
            </td>

            <!-- Arquivo -->
            <td>
              {% if doc.caminho_arquivo %}
                <a href="{{ url_for('clientes.abrir_documento', doc_id=doc.id) }}" target="_blank">
                  <i class="fas fa-file-pdf text-danger me-1"></i>
                  {{ doc.nome_original or 'arquivo' }}
                </a>
              {% else %}
                <span class="text-muted">Não enviado</span>
              {% endif %}
            </td>

            <!-- Ações -->
            <td class="text-center">
              <!-- Editar -->
              <button class="btn btn-sm btn-outline-primary me-1 btnEditarDoc"
                      data-cliente-id="{{ cliente.id }}"
                      data-doc-id="{{ doc.id }}"
                      title="Editar Documento">
                <i class="fas fa-edit"></i>
              </button>

              <!-- Excluir -->
              <form method="POST"
                    action="{{ url_for('clientes.deletar_documento', cliente_id=cliente.id, doc_id=doc.id) }}"
                    class="d-inline"
                    onsubmit="return confirm('Deseja realmente excluir este documento?')">
                <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir Documento">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}

          {% if cliente.documentos|length == 0 %}
          <tr>
            <td colspan="7" class="text-center text-muted py-3">
              <i class="fas fa-info-circle me-2"></i> Nenhum documento cadastrado.
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ====================== -->
<!-- MODAL: NOVO DOCUMENTO -->
<!-- ====================== -->
{% include 'clientes/abas/documentos_novo.html' %}

<!-- ====================== -->
<!-- MODAL DINÂMICO DE EDIÇÃO -->
<!-- ====================== -->
<div class="modal fade" id="modalEditarDocumentoDinamico" tabindex="-1" aria-labelledby="modalEditarDocumentoDinamicoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <!-- Cabeçalho padrão -->
      <div class="modal-header bg-white border-bottom">
        <h5 class="modal-title" id="modalEditarDocumentoDinamicoLabel">
          <i class="fas fa-pen-to-square me-2 text-primary"></i> Editar Documento
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <!-- Corpo: será preenchido dinamicamente via JS -->
      <div class="modal-body" id="modalEditarConteudo">
        <div class="text-center text-muted py-5">
          <i class="fas fa-spinner fa-spin me-2"></i>Carregando conteúdo...
        </div>
      </div>

      <!-- Rodapé padrão (opcional) -->
      <div class="modal-footer d-none" id="modalEditarFooter">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ====================== -->
<!-- SCRIPT: FIX DE BACKDROP -->
<!-- ====================== -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modalEl = document.getElementById("modalEditarDocumentoDinamico");

    modalEl.addEventListener("shown.bs.modal", () => {
      const backdrops = document.querySelectorAll(".modal-backdrop.show");
      if (backdrops.length > 1) {
        for (let i = 0; i < backdrops.length - 1; i++) backdrops[i].remove();
      }
      modalEl.style.zIndex = "1065";
    });

    modalEl.addEventListener("hidden.bs.modal", () => {
      const body = modalEl.querySelector("#modalEditarConteudo");
      if (body) {
        body.innerHTML = `
          <div class="text-center text-muted py-5">
            <i class="fas fa-spinner fa-spin me-2"></i>Carregando conteúdo...
          </div>`;
      }
    });
  });
</script>

<!-- ====================== -->
<!-- SCRIPT PRINCIPAL -->
<!-- ====================== -->
<script src="{{ url_for('static', filename='js/documentos.js') }}"></script>
