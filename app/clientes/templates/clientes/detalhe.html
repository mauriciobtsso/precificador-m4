{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm mb-4 border-0 d-none d-md-block">
        <div class="card-body d-flex align-items-center">
            <div class="me-3">
                <img src="{{ url_for('static', filename='img/avatar.png') }}" 
                     alt="avatar" class="rounded-circle border" width="80" height="80">
            </div>
            <div>
                <h4 class="mb-1">{{ cliente.nome }}</h4>
                <p class="text-muted mb-1">{{ cliente.razao_social or '' }}</p>
                <p class="mb-1">
                    <strong>CPF/CNPJ:</strong> {{ cliente.documento or 'não possui' }}
                    {% if cliente.cr %} / <strong>CR:</strong> {{ cliente.cr }}{% endif %}
                    {% if cliente.rg %} / <strong>RG:</strong> {{ cliente.rg }}{% endif %}
                    {% if cliente.matricula %}
                        / <strong>Matrícula:</strong> {{ cliente.matricula }}
                    {% else %}
                        / <strong>Matrícula:</strong> não possui
                    {% endif %}
                </p>
                <p class="mb-1">
                    <strong>Data de Nascimento:</strong>
                    {{ cliente.data_nascimento.strftime('%d/%m/%Y') if cliente.data_nascimento else 'não informado' }}
                </p>
                <p class="mb-1">
                    {% if cliente.contatos %}
                        {% for c in cliente.contatos %}
                            {% set valor_limpo = c.valor|replace('(','')|replace(')','')|replace('-','')|replace(' ','') %}
                            
                            {% if c.tipo|lower == 'telefone' %}
                                <a href="tel:{{ valor_limpo }}" class="me-2 text-decoration-none">
                                    <i class="fas fa-phone"></i> {{ c.valor }}
                                </a>
                            {% elif c.tipo|lower == 'celular' %}
                                <a href="tel:{{ valor_limpo }}" class="me-2 text-decoration-none">
                                    <i class="fas fa-mobile-alt"></i> {{ c.valor }}
                                </a>
                            {% elif c.tipo|lower in ['whatsapp','zap'] %}
                                <a href="https://wa.me/55{{ valor_limpo }}" target="_blank" class="me-2 text-success text-decoration-none">
                                    <i class="fab fa-whatsapp"></i> {{ c.valor }}
                                </a>
                            {% elif c.tipo|lower == 'email' %}
                                <a href="mailto:{{ c.valor }}" class="me-2 text-decoration-none">
                                    <i class="fas fa-envelope"></i> {{ c.valor }}
                                </a>
                            {% else %}
                                <span class="me-2"><strong>{{ c.tipo|capitalize }}:</strong> {{ c.valor }}</span>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">nenhum contato cadastrado</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-3 border-0 d-block d-md-none">
        <div class="card-body d-flex">
            <div class="me-3">
                <img src="{{ url_for('static', filename='img/avatar.png') }}" 
                     alt="avatar" class="rounded-circle border" width="64" height="64">
            </div>
            <div class="flex-grow-1">
                <h6 class="mb-1 fw-bold text-primary">{{ cliente.nome }}</h6>
                <small class="text-muted d-block">{{ cliente.documento or 'CPF/CNPJ não informado' }}</small>

                {% if cliente.cr or cliente.rg or cliente.matricula %}
                <small class="d-block">
                    {% if cliente.cr %}<strong>CR:</strong> {{ cliente.cr }} {% endif %}
                    {% if cliente.rg %}/ <strong>RG:</strong> {{ cliente.rg }} {% endif %}
                    {% if cliente.matricula %}/ <strong>Matrícula:</strong> {{ cliente.matricula }} {% endif %}
                </small>
                {% endif %}

                {% if cliente.data_nascimento %}
                <small class="d-block">
                    <i class="fas fa-birthday-cake me-1"></i> 
                    {{ cliente.data_nascimento.strftime('%d/%m/%Y') }}
                </small>
                {% endif %}
            </div>
        </div>

        <div class="list-group list-group-flush">
            {% for c in cliente.contatos %}
            {% set valor_limpo = c.valor|replace('(','')|replace(')','')|replace('-','')|replace(' ','') %}
            <div class="list-group-item py-1 px-3 border-0">
                <small>
                    {% if c.tipo|lower == 'telefone' %}
                        <a href="tel:{{ valor_limpo }}" class="text-decoration-none">
                            <i class="fas fa-phone fa-xs me-1"></i> {{ c.valor }}
                        </a>
                    {% elif c.tipo|lower == 'celular' %}
                        <a href="tel:{{ valor_limpo }}" class="text-decoration-none">
                            <i class="fas fa-mobile-alt fa-xs me-1"></i> {{ c.valor }}
                        </a>
                    {% elif c.tipo|lower in ['whatsapp','zap'] %}
                        <a href="https://wa.me/55{{ valor_limpo }}" target="_blank" class="text-success text-decoration-none">
                            <i class="fab fa-whatsapp fa-xs me-1"></i> {{ c.valor }}
                        </a>
                    {% elif c.tipo|lower == 'email' %}
                        <a href="mailto:{{ c.valor }}" class="text-decoration-none">
                            <i class="fas fa-envelope fa-xs me-1"></i> {{ c.valor }}
                        </a>
                    {% else %}
                        <i class="fas fa-tag fa-xs me-1"></i> {{ c.tipo|capitalize }}: {{ c.valor }}
                    {% endif %}
                </small>
            </div>
            {% else %}
            <div class="list-group-item py-1 px-3 border-0">
                <small class="text-muted">Nenhum contato cadastrado.</small>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="d-flex align-items-center mb-3">
        <a href="{{ url_for('clientes.index') }}" class="btn btn-sm btn-outline-secondary me-2">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>

        <a href="{{ url_for('clientes.editar_cliente', cliente_id=cliente.id) }}"
           class="btn btn-sm btn-outline-primary me-2">
          <i class="fas fa-edit"></i> Editar Cliente
        </a>

        <form method="post"
              action="{{ url_for('certidoes.criar_pacote_certidoes', cliente_id=cliente.id) }}"
              class="d-inline me-2">
            <button type="submit" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-file-signature"></i> Gerar Certidões
            </button>
        </form>

        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalExcluirCliente">
            <i class="fas fa-trash-alt"></i> Excluir Cliente
        </button>
    </div>

    <div class="modal fade" id="modalExcluirCliente" tabindex="-1" aria-labelledby="modalExcluirClienteLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="modalExcluirClienteLabel">
              <i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <p class="mb-0">
              Tem certeza que deseja excluir o cliente
              <strong>{{ cliente.nome }}</strong>?
              <br>
              <small class="text-muted">Esta ação removerá todos os dados associados e não poderá ser desfeita.</small>
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <form method="POST" action="{{ url_for('clientes.deletar_cliente', cliente_id=cliente.id) }}" class="d-inline">
              <button type="submit" class="btn btn-danger">
                <i class="fas fa-trash-alt"></i> Confirmar Exclusão
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <ul class="nav nav-tabs" id="clienteTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#visao">Visão Geral</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#vendas">
                <i class="fas fa-shopping-bag me-1"></i> Histórico de Compras
            </a>
        </li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#info">Informações</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#docs">Documentos</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#armas">Armas</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#com">Comunicações</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#proc">Processos</a></li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#certidoes">
                <i class="fas fa-file-signature me-1"></i> Certidões
            </a>
        </li>
    </ul>

    <div class="tab-content border p-3 border-top-0 bg-white">
        <div class="tab-pane fade show active" id="visao">
            <div class="row g-3 mb-4 text-center">
                <div class="col-6 col-md-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <i class="fas fa-shopping-bag fa-2x text-secondary mb-2"></i>
                            <h6 class="card-title text-muted small">Compras</h6>
                            <p class="display-6 fw-bold text-dark mb-0">{{ resumo.vendas }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-6 col-md-2">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                            <h6 class="card-title text-muted small">Documentos</h6>
                            <p class="display-6 fw-bold text-dark mb-0">{{ resumo.documentos }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <i class="fas fa-gun fa-2x text-success mb-2"></i>
                            <h6 class="card-title text-muted small">Armas</h6>
                            <p class="display-6 fw-bold text-dark mb-0">{{ resumo.armas }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <i class="fas fa-comments fa-2x text-info mb-2"></i>
                            <h6 class="card-title text-muted small">Comunicações</h6>
                            <p class="display-6 fw-bold text-dark mb-0">{{ resumo.comunicacoes }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <i class="fas fa-tasks fa-2x text-warning mb-2"></i>
                            <h6 class="card-title text-muted small">Processos</h6>
                            <p class="display-6 fw-bold text-dark mb-0">{{ resumo.processos }}</p>
                        </div>
                    </div>
                </div>
            </div>

            {% if alertas %}
            <div class="alert alert-danger rounded-3 shadow-sm">
                <h6 class="fw-bold"><i class="fas fa-exclamation-triangle me-2"></i> Alertas</h6>
                <ul class="mb-0">
                    {% for alerta in alertas %}
                    <li>{{ alerta }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="card shadow-sm mt-4 border-0">
                <div class="card-header bg-light border-bottom-0 rounded-top">
                    <strong><i class="fas fa-stream me-2"></i> Últimos Eventos</strong>
                </div>
                <div class="card-body">
                    {% if timeline %}
                        <ul class="timeline list-unstyled mb-0">
                            {% for evento in timeline %}
                            <li class="mb-3 border-start border-3 ps-3 border-secondary">
                                <small class="text-muted">{{ evento.data.strftime('%d/%m/%Y %H:%M') }}</small><br>
                                <strong class="text-dark">{{ evento.tipo }}</strong> <span class="text-muted">— {{ evento.descricao }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">Nenhum evento recente.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="vendas">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-secondary">
                    <i class="fas fa-list me-2"></i> Lista de Pedidos
                </h5>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th>Data</th>
                            <th>Status</th>
                            <th>Valor Total</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for venda in cliente.vendas|sort(attribute='data_abertura', reverse=True) %}
                        <tr>
                            <td class="fw-bold text-secondary">#{{ venda.id }}</td>
                            <td>{{ venda.data_abertura.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>
                                <span class="badge rounded-pill
                                    {% if (venda.status or '').lower().startswith('aber') %} bg-warning text-dark
                                    {% elif (venda.status or '').lower().startswith('fech') or (venda.status or '').lower().startswith('concl') %} bg-success
                                    {% elif (venda.status or '').lower().startswith('canc') %} bg-danger
                                    {% else %} bg-secondary
                                    {% endif %}">
                                    {{ venda.status or 'N/A' }}
                                </span>
                            </td>
                            <td class="fw-semibold text-success">
                                R$ {{ "{:,.2f}".format(venda.valor_total or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}
                            </td>
                            <td class="text-end">
                                <a href="{{ url_for('sales_core.venda_detalhe', venda_id=venda.id) }}" 
                                   class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                    <i class="fas fa-eye me-1"></i> Ver Detalhes
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-5">
                                <i class="fas fa-shopping-cart fa-3x mb-3 text-light"></i><br>
                                Este cliente ainda não realizou compras.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="info">
            {% include "clientes/abas/informacoes.html" %}
        </div>

        <div class="tab-pane fade" id="docs">
            {% include "clientes/abas/documentos.html" %}
        </div>

        <div class="tab-pane fade" id="armas">
            {% include "clientes/abas/armas.html" %}
        </div>

        <div class="tab-pane fade" id="com">
            {% include "clientes/abas/comunicacoes.html" %}
        </div>

        <div class="tab-pane fade" id="proc">
            {% include "clientes/abas/processos.html" %}
        </div>

        <div class="tab-pane fade" id="certidoes">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-secondary">
                    <i class="fas fa-file-signature me-2"></i> Certidões
                </h5>
                <form method="post"
                      action="{{ url_for('certidoes.criar_pacote_certidoes', cliente_id=cliente.id) }}"
                      class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus-circle me-1"></i> Gerar certidões padrão
                    </button>
                </form>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Solicitada em</th>
                            <th>Emitida em</th>
                            <th>Validade</th>
                            <th class="text-end">Portal / Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set certs_ordenadas = cliente.certidoes|sort(attribute='data_solicitacao', reverse=True) %}
                        {% for c in certs_ordenadas %}
                        <tr>
                            <td>{{ c.label_tipo() }}</td>
                            <td>
                                {% set s = c.status.name if c.status is not none else '' %}
                                <span class="badge
                                    {% if s == 'PENDENTE' %} bg-warning text-dark
                                    {% elif s == 'EM_PROCESSO' %} bg-info text-dark
                                    {% elif s == 'EMITIDA' %} bg-success
                                    {% elif s == 'ERRO' %} bg-danger
                                    {% elif s == 'CANCELADA' %} bg-secondary
                                    {% else %} bg-light text-dark
                                    {% endif %}">
                                    {{ c.label_status() }}
                                </span>
                            </td>
                            <td>
                                {% if c.data_solicitacao %}
                                    {{ c.data_solicitacao.strftime('%d/%m/%Y %H:%M') }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td>
                                {% if c.data_emissao %}
                                    {{ c.data_emissao.strftime('%d/%m/%Y %H:%M') }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td>
                                {% if c.validade_ate %}
                                    {{ c.validade_ate.strftime('%d/%m/%Y') }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if c.url_portal %}
                                    <a href="{{ c.url_portal }}" target="_blank" class="btn btn-sm btn-outline-secondary me-1">
                                        Abrir portal
                                    </a>
                                {% endif %}
                                <button type="button"
                                        class="btn btn-sm btn-outline-primary me-1"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalCertidao{{ c.id }}">
                                    Atualizar
                                </button>
                                {% if c.arquivo_storage_key %}
                                    <a href="{{ url_for('certidoes.baixar_certidao', certidao_id=c.id) }}"
                                       class="btn btn-sm btn-outline-success me-1">
                                        <i class="fas fa-download me-1"></i> Abrir
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                Nenhuma certidão cadastrada para este cliente.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% for c in certs_ordenadas %}
            <div class="modal fade" id="modalCertidao{{ c.id }}" tabindex="-1" aria-labelledby="modalCertidaoLabel{{ c.id }}" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                  <form method="post"
                        action="{{ url_for('certidoes.gerar_certidao', certidao_id=c.id) }}"
                        class="d-inline">
                    <div class="modal-header bg-light">
                      <h5 class="modal-title" id="modalCertidaoLabel{{ c.id }}">
                        <i class="fas fa-file-signature me-2"></i>
                        Atualizar Certidão – {{ c.label_tipo() }}
                      </h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select form-select-sm">
                          <option value="">Manter atual ({{ c.label_status() }})</option>
                          <option value="pendente"      {% if c.status and c.status.value == 'pendente' %}selected{% endif %}>Pendente</option>
                          <option value="em_processo"   {% if c.status and c.status.value == 'em_processo' %}selected{% endif %}>Em processo</option>
                          <option value="emitida"       {% if c.status and c.status.value == 'emitida' %}selected{% endif %}>Emitida</option>
                          <option value="erro"          {% if c.status and c.status.value == 'erro' %}selected{% endif %}>Erro</option>
                          <option value="cancelada"     {% if c.status and c.status.value == 'cancelada' %}selected{% endif %}>Cancelada</option>
                        </select>
                      </div>

                      <div class="row g-2 mb-3">
                        <div class="col-md-6">
                          <label class="form-label">Data/hora de emissão</label>
                          <input type="datetime-local"
                                 name="data_emissao"
                                 class="form-control form-control-sm"
                                 value="{% if c.data_emissao %}{{ c.data_emissao.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Validade até</label>
                          <input type="date"
                                 name="validade_ate"
                                 class="form-control form-control-sm"
                                 value="{% if c.validade_ate %}{{ c.validade_ate.strftime('%Y-%m-%d') }}{% endif %}">
                        </div>
                      </div>

                      <div class="mb-2">
                        <label class="form-label">Arquivo PDF da certidão</label>
                        <input type="file"
                               name="arquivo_pdf"
                               accept="application/pdf"
                               class="form-control form-control-sm">
                        {% if c.arquivo_storage_key %}
                        <div class="form-text">
                          Já existe um PDF salvo para esta certidão.
                        </div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                        Cancelar
                      </button>
                      <button type="submit" class="btn btn-primary btn-sm">
                        Salvar alterações
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
