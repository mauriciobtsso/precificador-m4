{% extends "base.html" %}
{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h5 class="fw-bold mb-0 text-dark">
            <i class="fas fa-boxes me-2 text-primary"></i>Conferência e Recebimento
        </h5>
        <div class="text-muted small mt-1">
            NF: <strong class="text-dark">{{ nf.numero }}</strong> 
            <span class="mx-2">|</span> 
            Pedido: 
            {% if nf.pedido %}
                <a href="{{ url_for('pedidos.editar_pedido', id=nf.pedido.id) }}" class="fw-bold text-primary text-decoration-none">
                    #{{ nf.pedido.numero }}
                </a>
                <span class="badge bg-light text-dark border ms-1">{{ nf.pedido.status }}</span>
            {% else %}
                <span class="badge bg-secondary">S/V (Avulso)</span>
            {% endif %}
        </div>
    </div>
    <a href="{{ url_for('compras_nf.index') }}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Voltar
    </a>
  </div>

  <div class="card mb-3 shadow-sm border-0 bg-light">
    <div class="card-body py-2 px-3">
        <div class="row align-items-center small">
            <div class="col-md-5">
                <strong>Fornecedor:</strong> {{ nf.fornecedor or 'Não Informado' }}
                {% if nf.cnpj_fornecedor %}<span class="text-muted ms-1">({{ nf.cnpj_fornecedor }})</span>{% endif %}
            </div>
            <div class="col-md-4">
                <strong>Chave:</strong> <span class="text-muted text-truncate d-inline-block align-bottom" style="max-width: 250px;">{{ nf.chave or 'N/A' }}</span>
            </div>
            <div class="col-md-3 text-end">
                <strong>Total NF:</strong> <span class="text-success fw-bold fs-6">{{ nf.valor_total|currency }}</span>
            </div>
        </div>
    </div>
  </div>

  <div class="card mb-3 shadow-sm border-0">
    <div class="card-body py-2 bg-white">
         <form action="{{ url_for('compras_nf.upload_guia_nf', nf_id=nf.id) }}" method="POST" enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
            <label class="small fw-bold text-nowrap">Guia de Trânsito (GT):</label>
            <input type="file" name="guia_file" class="form-control form-control-sm" accept=".pdf,.jpg,.png">
            <input type="text" name="numero_selo" class="form-control form-control-sm" placeholder="Nº Selo (Opcional)" value="{{ nf.numero_selo or '' }}" style="max-width: 150px;">
            <button type="submit" class="btn btn-sm btn-primary text-nowrap"><i class="fas fa-cloud-upload-alt me-1"></i> Salvar GT</button>
            {% if nf.guia_transito_file %}
                <a href="{{ nf.guia_transito_file }}" target="_blank" class="btn btn-sm btn-outline-success ms-2"><i class="fas fa-eye"></i> Ver</a>
            {% endif %}
        </form>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-header bg-white py-2">
        <h6 class="mb-0 fw-bold text-secondary small text-uppercase">Itens da Nota Fiscal</h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0" style="font-size: 0.85rem;">
                <thead class="bg-light text-secondary">
                    <tr>
                        <th class="ps-3" style="width: 30%;">Produto XML</th>
                        <th class="text-center" style="width: 10%;">Qtd</th>
                        <th style="width: 35%;">Vínculo Sistema (De/Para)</th>
                        <th style="width: 15%;">Conferência</th>
                        <th class="text-end pe-3" style="width: 10%;">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in nf.itens %}
                    {% set ja_recebido = item.itens_gerados_estoque.count() > 0 %}
                    {% set eh_arma = item.seriais_xml or 'PISTOLA' in item.descricao.upper() or 'RIFLE' in item.descricao.upper() or 'REVOLVER' in item.descricao.upper() %}
                    
                    <tr class="{{ 'bg-success-subtle' if ja_recebido else '' }}" data-tipo="{{ 'arma' if eh_arma else 'municao' }}">
                        
                        <td class="ps-3">
                            <strong class="d-block text-truncate" style="max-width: 300px;" title="{{ item.descricao }}">
                                {{ item.descricao }}
                            </strong>
                            <div class="text-muted d-flex gap-2 small">
                                <span>{{ item.marca }}</span>
                                <span>{{ item.modelo }}</span>
                            </div>
                            {% if item.lote %}
                                <span class="badge bg-light text-dark border mt-1">Lote XML: {{ item.lote }}</span>
                            {% endif %}
                        </td>

                        <td class="text-center fw-bold fs-6">{{ item.quantidade|int }}</td>
                        
                        <td>
                            {% if ja_recebido %}
                                {% set est = item.itens_gerados_estoque.first() %}
                                <div class="small text-success">
                                    <i class="fas fa-link me-1"></i> {{ est.produto.nome }} 
                                    <span class="d-block text-muted" style="font-size: 0.75rem;">SKU: {{ est.produto.codigo }}</span>
                                </div>
                            {% else %}
                                <select class="select2-produto" data-compra-item-id="{{ item.id }}" style="width: 100%;">
                                    {% if item.produto_id %}
                                        <option value="{{ item.produto_id }}" selected>
                                            {{ item.produto_sugerido.nome }} ({{ item.produto_sugerido.codigo }})
                                        </option>
                                    {% else %}
                                        <option value="">Buscar no catálogo...</option>
                                    {% endif %}
                                </select>
                            {% endif %}
                        </td>

                        <td>
                            {% if ja_recebido %}
                                <small class="text-success"><i class="fas fa-check-circle"></i> Recebido</small>
                            {% else %}
                                {% if eh_arma %}
                                    {% set qtd = item.quantidade|int %}
                                    {% set serials = item.seriais_xml.split(',') if item.seriais_xml else [] %}
                                    <div class="mb-2" style="max-height: 120px; overflow-y: auto;">
                                        {% for i in range(qtd) %}
                                        <input type="text" class="form-control form-control-sm mb-1 serial-input" 
                                               value="{{ serials[i] if i < serials|length else '' }}" 
                                               placeholder="Serial #{{ i+1 }}">
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="text-muted small fst-italic">
                                        <i class="fas fa-info-circle"></i> Lote e Embalagem serão definidos na gestão de estoque.
                                    </div>
                                {% endif %}
                            {% endif %}
                        </td>

                        <td class="text-end pe-3">
                            {% if ja_recebido %}
                                <button class="btn btn-outline-danger btn-sm btn-desfazer" data-compra-item-id="{{ item.id }}" title="Desfazer"><i class="fas fa-undo"></i></button>
                            {% else %}
                                <button class="btn btn-primary btn-sm w-100 btn-receber" data-item-id="{{ item.id }}">
                                    <i class="fas fa-download me-1"></i> Receber
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    $('.select2-produto').select2({
        theme: 'bootstrap-5',
        placeholder: "Digite o nome ou código...",
        allowClear: true,
        dropdownParent: $('body'), 
        ajax: {
            url: "{{ url_for('produtos.api_buscar_produtos') }}",
            dataType: 'json',
            delay: 300,
            data: function (params) { return { termo: params.term }; },
            processResults: function (data) { return { results: data.map(p => ({ id: p.id, text: p.text })) }; },
            cache: true
        }
    });

    document.querySelectorAll('.btn-receber').forEach(btn => {
        btn.addEventListener('click', async function() {
            const row = this.closest('tr');
            const itemId = this.dataset.itemId;
            const produtoId = $(row.querySelector('.select2-produto')).val();
            const tipoItem = row.dataset.tipo;
            
            if (!produtoId) { alert("⚠️ Vincule o produto do sistema."); return; }

            const formData = new FormData();
            formData.append('compra_item_id', itemId);
            formData.append('produto_id', produtoId);
            formData.append('tipo_item', tipoItem);
            
            if (tipoItem === 'arma') {
                const serials = Array.from(row.querySelectorAll('.serial-input')).map(i => i.value.trim());
                if (serials.some(s => !s) && !confirm("Seriais vazios. Continuar?")) return;
                formData.append('serials', JSON.stringify(serials));
            }
            
            // Munição vai sem payload extra, entrada 'bulk'

            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const r = await fetch("{{ url_for('compras_nf.receber_item') }}", { method: 'POST', body: formData });
                const res = await r.json();
                if (res.success) { window.location.reload(); } 
                else { alert("Erro: " + res.message); this.disabled = false; this.innerHTML = '<i class="fas fa-download"></i> Receber'; }
            } catch(e) { console.error(e); alert("Erro."); this.disabled = false; }
        });
    });

    document.querySelectorAll('.btn-desfazer').forEach(btn => {
        btn.addEventListener('click', async function() {
            if(!confirm("Desfazer recebimento?")) return;
            try {
                const r = await fetch("{{ url_for('compras_nf.desfazer_recebimento') }}", {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({compra_item_id: this.dataset.compraItemId})
                });
                if((await r.json()).success) window.location.reload();
                else alert("Erro ao desfazer.");
            } catch(e) { alert("Erro."); }
        });
    });
});
</script>
{% endblock %}