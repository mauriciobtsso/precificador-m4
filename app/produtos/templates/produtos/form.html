{% extends "base.html" %}
{% block content %}

<!-- ============================================================
     FORMULÁRIO DE PRODUTO — Sprint 6G (Completo e Revisado)
============================================================ -->

<div class="container" data-produto-id="{{ produto.id if produto else '' }}">
  
  <!-- ============================================================
       CABEÇALHO (refinado Sprint 6F)
  ============================================================ -->
  {% include "produtos/form/includes/_header.html" %}

  <!-- ============================================================
       ABAS DO FORMULÁRIO (Geral, Preços, Estoque, Técnicos, Documentos)
  ============================================================ -->
  {% include "produtos/form/includes/_tabs.html" %}

  <!-- ============================================================
       BOTÕES DE AÇÃO (fixos no final do formulário)
  ============================================================ -->
  <div class="d-flex gap-2 mt-3">
    <button type="button" id="btnSalvarProduto" class="btn btn-orange">
      <span class="icon me-1"><i class="fas fa-save"></i></span> Salvar
    </button>
    <a href="{{ url_for('produtos.index') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i> Cancelar
    </a>

    {% if produto and produto.id %}
      <form action="{{ url_for('produtos.excluir_produto', produto_id=produto.id) }}"
            method="POST"
            onsubmit="return confirm('Tem certeza que deseja excluir este produto?');"
            class="ms-auto">
        <button type="submit" class="btn btn-outline-danger" title="Excluir produto">
          <i class="fas fa-trash-alt"></i>
        </button>
      </form>
    {% endif %}
  </div>

  <!-- ============================================================
       STATUS DE SALVAMENTO AUTOMÁTICO
  ============================================================ -->
  <div class="text-end mt-2">
    <small id="saveStatus" class="text-muted">Aguardando alterações...</small>
  </div>

</div>

<!-- ============================================================
     SCRIPTS — Máscaras, Cálculos e Autosave
============================================================ -->
<script src="https://cdn.jsdelivr.net/npm/autonumeric@4.10.5"></script>

<!-- Módulo principal (cálculo, resumo e foto) -->
<script src="{{ url_for('static', filename='js/produtos_form.js') }}"></script>

<!-- Autosave AJAX (persistência em tempo real) -->
<script src="{{ url_for('static', filename='js/produtos_autosave.js') }}"></script>

<!-- Histórico de alterações (carregamento assíncrono) -->
<script src="{{ url_for('static', filename='js/produtos_historico.js') }}"></script>

<!-- Configurações de modais (categorias, marcas, calibres etc.) -->
<script src="{{ url_for('static', filename='js/configs_modals.js') }}"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    console.log("[M4] produto_form HTML carregado ✅");

    // Inicialização da foto (Sprint 6E)
    if (typeof initFotoProduto === "function") {
      console.log("[M4] initFotoProduto() disparado ✅");
      initFotoProduto();
    }

    // Força recalcular no carregamento (garantia)
    if (typeof recalcularProduto === "function") {
      setTimeout(() => recalcularProduto(), 600);
    }
  });
</script>

<!-- ============================================================
     ESTILOS COMPLEMENTARES (ajustes visuais rápidos)
============================================================ -->
<style>
  .card-header { font-size: .95rem; }
  .input-group-text i { font-size: .9rem; }
  .form-label { font-weight: 500; }
</style>

{% endblock %}
