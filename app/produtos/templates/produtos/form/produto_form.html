{% extends "base.html" %}
{% block content %}

<div class="container py-3" data-produto-id="{{ produto.id or '' }}">
  {# =========================
     CABEÇALHO (include)
  ========================== #}
  {% include "produtos/form/includes/_header.html" %}
  
  {# =========================
     BLOCO DA FOTO DO PRODUTO (upload e preview, SOMENTE NO FORM)
     IDs: inputFotoProduto, btnSelecionarFoto, btnRemoverFoto, fotoProdutoPreview, inputFotoUrl
     MOVIDO PARA _geral.html
  ========================== #}

  <!-- ============================================================
       FORMULÁRIO PRINCIPAL
  ============================================================ -->
  <form method="POST" action="" class="needs-validation" novalidate id="produtoForm">



	  <!-- ABAS -->
    <ul class="nav nav-tabs" id="produtoTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-geral" type="button" role="tab"
                data-bs-toggle="tab" data-bs-target="#abaGeral"
                aria-controls="abaGeral" aria-selected="true">
          <i class="fas fa-box me-1"></i> Geral
        </button>
      </li>

      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-precos" type="button" role="tab"
                data-bs-toggle="tab" data-bs-target="#abaPrecos"
                aria-controls="abaPrecos" aria-selected="false">
          <i class="fas fa-coins me-1"></i> Preços
        </button>
      </li>

      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-tecnicos" type="button" role="tab"
                data-bs-toggle="tab" data-bs-target="#abaTecnicos"
                aria-controls="abaTecnicos" aria-selected="false">
          <i class="fas fa-tools me-1"></i> Técnicos
        </button>
      </li>

      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-historico" type="button" role="tab"
                data-bs-toggle="tab" data-bs-target="#abaHistorico"
                aria-controls="abaHistorico" aria-selected="false">
          <i class="fas fa-history me-1"></i> Histórico
        </button>
      </li>
    </ul>

	    <!-- CONTEÚDO DAS ABAS -->
	    <div class="tab-content p-3 border border-top-0 rounded-bottom fade-in">
      <div class="tab-pane fade show active" id="abaGeral" role="tabpanel">
        {% include "produtos/form/abas/_geral.html" %}
      </div>
      <div class="tab-pane fade" id="abaPrecos" role="tabpanel">
        {% include "produtos/form/abas/_precos.html" %}
      </div>
      <div class="tab-pane fade" id="abaTecnicos" role="tabpanel">
        {% include "produtos/form/abas/_tecnicos.html" %}
      </div>
      <div class="tab-pane fade" id="abaHistorico" role="tabpanel" data-produto-id="{{ produto.id }}">
        {% include "produtos/form/abas/_historico.html" %}
      </div>
    </div>

	    {# Rodapé com botão salvar #}
	    {% include "produtos/form/includes/_footer.html" %}
	  </form>
	</div>

{# Toast de sucesso #}
{% include "produtos/form/includes/_toast.html" %}

{# ================================
   MODAIS (categorias, tipo, marca…)
================================ #}
{% include "produtos/form/modais/_modal_categoria.html" %}
{% include "produtos/form/modais/_modal_tipo.html" %}
{% include "produtos/form/modais/_modal_marca.html" %}
{% include "produtos/form/modais/_modal_calibre.html" %}
{% include "produtos/form/modais/_modal_funcionamento.html" %}

{% endblock %}

{# ============================================================
   SCRIPTS (ordem crítica para restaurar comportamentos)
============================================================ #}
{% block scripts %}
  {{ super() }}

  <!-- CSS específico da Fase 5 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/produtos_form.css') }}">

  <!-- AutoNumeric -->
  <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.10.5"></script>

  <!-- Módulos JS -->
  <script src="{{ url_for('static', filename='js/produtos_form.js') }}"></script>
  <script src="{{ url_for('static', filename='js/produtos_autosave.js') }}"></script>
  <script src="{{ url_for('static', filename='js/produtos_historico.js') }}"></script>
  <script src="{{ url_for('static', filename='js/configs_modals.js') }}"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      console.log("[M4] produto_form HTML carregado ✅");
      document.querySelectorAll("button:not([type])").forEach(btn => btn.setAttribute("type", "button"));
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

      // ⚙️ Inicialização do módulo de foto foi movida para produtos_form.js
      // para garantir que o DOM esteja pronto antes de anexar eventos.
      // O código de inicialização do módulo de foto foi removido daqui.
    });

    window.addEventListener("load", () => {
      if (window.ProdutosForm?.init) window.ProdutosForm.init();
      if (window.ConfigsModals?.init) window.ConfigsModals.init();
    });

    document.addEventListener('shown.bs.tab', evt => {
      if (window.ProdutosForm?.reinitMasks) window.ProdutosForm.reinitMasks();
      if (window.ProdutosForm?.refreshResumo) window.ProdutosForm.refreshResumo();
    });
  </script>
{% endblock %}