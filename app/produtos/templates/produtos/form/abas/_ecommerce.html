<div class="row g-4 py-2">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body bg-light rounded border">
                <h6 class="fw-bold mb-3 text-uppercase small text-muted"><i class="fas fa-eye me-2"></i>Exibição na Vitrine</h6>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="visivel_loja" name="visivel_loja" {% if produto.visivel_loja %}checked{% endif %}>
                    <label class="form-check-label fw-bold" for="visivel_loja">Publicar na Loja</label>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted text-uppercase">Destaques</label>
                    <div class="form-check mb-1 small">
                        <input class="form-check-input" type="checkbox" name="destaque_home" {% if produto.destaque_home %}checked{% endif %}>
                        <label class="form-check-label">Destaque na Home</label>
                    </div>
                    <div class="form-check mb-1 small">
                        <input class="form-check-input" type="checkbox" name="eh_lancamento" {% if produto.eh_lancamento %}checked{% endif %}>
                        <label class="form-check-label">Selo Lançamento</label>
                    </div>
                </div>
                <hr>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="requer_documentacao" {% if produto.requer_documentacao %}checked{% endif %}>
                    <label class="form-check-label fw-bold small">Requer CR (WhatsApp)</label>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm border-dark">
            <div class="card-header bg-dark text-warning fw-bold small py-2">SEO / GOOGLE</div>
            <div class="card-body bg-white text-dark">
                <div class="mb-3">
                    <label class="form-label small fw-bold text-dark text-uppercase">Título da Página (Meta Title)</label>
                    <input type="text" class="form-control border-dark text-dark fw-bold" name="meta_title" 
                           value="{{ produto.meta_title or '' }}" placeholder="Título para busca" 
                           style="background-color: #ffffff !important; color: #000000 !important; border: 1px solid #000 !important;">
                </div>
                <div class="mb-0">
                    <label class="form-label small fw-bold text-dark text-uppercase d-flex justify-content-between">
                        Descrição de Busca
                        <span id="char-count-seo" class="badge bg-secondary">0 / 160</span>
                    </label>
                    <textarea class="form-control border-dark text-dark" name="meta_description" id="seo_description_input" rows="5" 
                              maxlength="160" placeholder="Resumo para o Google..." 
                              style="background-color: #ffffff !important; color: #000000 !important; border: 1px solid #000 !important;">{{ produto.meta_description or '' }}</textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card border-0 shadow-sm mb-4 border-start border-4 border-primary">
            <div class="card-body">
                <h6 class="fw-bold mb-4 text-uppercase small text-muted border-bottom pb-2">Conteúdo Comercial</h6>
                <div class="mb-4">
                    <label class="form-label fw-bold text-primary">Nome de Exibição na Loja (Amigável)</label>
                    <input type="text" class="form-control form-control-lg border-primary fw-bold" 
                           name="nome_comercial" value="{{ produto.meta_title or produto.nome }}">
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold small text-muted text-uppercase">Caminho da URL (Slug)</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-light text-muted">/produto/</span>
                        <input type="text" class="form-control border-dark-subtle" id="slug_input_ecommerce" name="slug" 
                               value="{{ produto.slug or '' }}" readonly style="background-color: #f8f9fa;">
                        <button class="btn btn-warning" type="button" id="btn_lock_ecommerce" onclick="handleSlugUnlockEcommerce()">
                            <i id="slug_icon_ecommerce" class="fas fa-lock"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold small text-muted text-uppercase">Resumo de Venda</label>
                    <textarea class="form-control" name="descricao_comercial" rows="2">{{ produto.descricao_comercial or '' }}</textarea>
                </div>
                <div class="mb-0">
                    <label class="form-label fw-bold text-dark text-uppercase small mb-2">Ficha Técnica (HTML)</label>
                    <div class="editor-wrapper-m4 border rounded bg-white shadow-sm" style="min-height: 460px;">
                        <textarea id="editor_loja_m4" class="richeditor" name="descricao_longa">{{ produto.descricao_longa or '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .editor-wrapper-m4 { width: 100%; display: block; clear: both; }
    .note-editor.note-frame { width: 100% !important; min-height: 450px !important; }
</style>

<script>
function handleSlugUnlockEcommerce() {
    const input = document.getElementById('slug_input_ecommerce');
    const icon = document.getElementById('slug_icon_ecommerce');
    const btn = document.getElementById('btn_lock_ecommerce');
    input.readOnly = !input.readOnly;
    input.style.backgroundColor = input.readOnly ? "#f8f9fa" : "#fff";
    icon.className = input.readOnly ? "fas fa-lock" : "fas fa-lock-open";
    btn.className = input.readOnly ? "btn btn-warning" : "btn btn-danger";
}

// Inicializador com salvamento forçado
window.dispararSummernoteM4 = function() {
    const $editor = $("#editor_loja_m4");
    if (typeof $.fn.summernote !== "undefined") {
        if ($editor.next().hasClass("note-editor")) { $editor.summernote("destroy"); }
        $editor.summernote({
            height: 450, lang: "pt-BR",
            callbacks: {
                onBlur: function() {
                    const contents = $editor.summernote('code');
                    $editor.val(contents);
                    $editor[0].dispatchEvent(new Event("change", { bubbles: true }));
                },
                onChange: function(contents) { $editor.val(contents); }
            }
        });
    }
};

// Contador de SEO
$(document).ready(function() {
    const $seoInput = $('#seo_description_input');
    const $seoCount = $('#char-count-seo');
    $seoInput.on('input', function() {
        const len = $(this).val().length;
        $seoCount.text(len + ' / 160');
        $seoCount.toggleClass('bg-danger', len >= 155);
    }).trigger('input');
});
</script>