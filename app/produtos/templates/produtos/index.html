{% extends "base.html" %}
{% block content %}

<!-- =======================
     CABEÇALHO
======================= -->

<div class="d-flex justify-content-between align-items-center mb-2">
  <div>
    <h2 class="fw-semibold mb-0">
      <i class="fas fa-box text-dark me-2"></i> Produtos
    </h2>
    <small class="text-muted">Gerencie, simule e compartilhe valores rapidamente.</small>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('produtos.gerenciar_produto') }}" class="btn btn-sm text-white shadow-sm"
       style="background:#ff5e00;border-color:#ff5e00">
      <i class="fas fa-plus me-1"></i> Novo
    </a>
    <a href="{{ url_for('produtos.importar_produtos') }}" class="btn btn-sm btn-outline-secondary shadow-sm">
      <i class="fas fa-file-upload me-1"></i> Importar
    </a>
    <a href="{{ url_for('main.parcelamento_rapido') }}" class="btn btn-sm btn-outline-dark shadow-sm">
      <i class="fas fa-calculator me-1"></i> Simular
    </a>
  </div>
</div>

<!-- Contador e controle -->

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
  <span class="badge bg-light text-dark border">
    {{ pagination.total }} resultado{{ '' if pagination.total == 1 else 's' }}
  </span>

  <form id="formPerPage" method="get" class="d-flex align-items-center gap-2">
    {% for key, value in request.args.items() if key not in ['per_page', 'page'] %}
      <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
    <label for="per_page" class="text-muted small mb-0">Mostrar:</label>
    <select name="per_page" id="per_page" class="form-select form-select-sm" style="width:auto;">
      <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
      <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
      <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
    </select>
  </form>
</div>

<!-- =======================
     FILTROS
======================= -->

<div class="card shadow-sm mb-3 border-0">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <i class="fas fa-filter me-2 text-muted"></i>
      <strong>Filtros</strong>
    </div>
    <div class="d-flex align-items-center gap-2">
      {% set tem_filtro = request.args.get('termo')
                          or request.args.get('tipo')
                          or request.args.get('marca')
                          or request.args.get('categoria')
                          or request.args.get('calibre')
                          or request.args.get('ordenar') %}
      {% if tem_filtro %}
        <a href="{{ url_for('produtos.index') }}" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-eraser me-1"></i> Limpar
        </a>
      {% endif %}
      <button class="btn btn-sm btn-link text-muted" data-bs-toggle="collapse" data-bs-target="#filtros">
        <i class="fas fa-chevron-down"></i>
      </button>
    </div>
  </div>

  <div id="filtros" class="collapse show card-body border-top">
    <form id="formFiltros" method="GET" class="row g-2">
      <div class="col-md-3">
        <div class="input-group">
          <input type="text" name="termo" value="{{ request.args.get('termo','') }}"
                 class="form-control" placeholder="Buscar por código ou nome" id="inTermo" autocomplete="off">
          <span class="input-group-text bg-white border-start-0" id="spinnerBusca" style="display:none;">
            <div class="spinner-inline"></div>
          </span>
        </div>
      </div>

      <div class="col-md-2">
        <select name="tipo" class="form-select">
          <option value="">— Tipo —</option>
          {% for t in tipos %}
            <option value="{{ t.id }}" {% if request.args.get('tipo')|int == t.id %}selected{% endif %}>{{ t.nome }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <select name="marca" class="form-select">
          <option value="">— Marca —</option>
          {% for m in marcas %}
            <option value="{{ m.id }}" {% if request.args.get('marca')|int == m.id %}selected{% endif %}>{{ m.nome }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <select name="categoria" class="form-select">
          <option value="">— Categoria —</option>
          {% for c in categorias %}
            <option value="{{ c.id }}" {% if request.args.get('categoria')|int == c.id %}selected{% endif %}>{{ c.nome }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <select name="calibre" class="form-select">
          <option value="">— Calibre —</option>
          {% for cal in calibres %}
            <option value="{{ cal.id }}" {% if request.args.get('calibre')|int == cal.id %}selected{% endif %}>{{ cal.nome }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-1">
        <select name="ordenar" class="form-select">
          <option value="nome_asc" {% if request.args.get('ordenar') == 'nome_asc' %}selected{% endif %}>Nome ↑</option>
          <option value="nome_desc" {% if request.args.get('ordenar') == 'nome_desc' %}selected{% endif %}>Nome ↓</option>
          <option value="preco_asc" {% if request.args.get('ordenar') == 'preco_asc' %}selected{% endif %}>Preço ↑</option>
          <option value="preco_desc" {% if request.args.get('ordenar') == 'preco_desc' %}selected{% endif %}>Preço ↓</option>
          <option value="lucro_desc" {% if request.args.get('ordenar') == 'lucro_desc' %}selected{% endif %}>Lucro ↓</option>
          <option value="atualizado_em_desc" {% if request.args.get('ordenar') == 'atualizado_em_desc' %}selected{% endif %}>Atualizado ↓</option>
        </select>
      </div>

      <div class="col-md-12 col-lg-1 d-grid">
        <button type="submit" class="btn text-white" style="background:#ff5e00;border-color:#ff5e00">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- =======================
     LISTA + PAGINAÇÃO
======================= -->

<div id="produtosLista" class="fade-in">
  {% include 'produtos/_lista.html' %}
</div>

<!-- =======================
     MODAL EXCLUIR
======================= -->

<div class="modal fade" id="modalExcluirProduto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-trash text-danger me-2"></i> Confirmar exclusão</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-1">Tem certeza que deseja excluir o produto abaixo?</p>
        <div class="border rounded p-2 bg-light">
          <div><strong>Nome:</strong> <span id="ex_nome">—</span></div>
          <div><strong>Código:</strong> <span id="ex_sku">—</span></div>
        </div>
        <small class="text-muted d-block mt-2">Esta ação não pode ser desfeita.</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="ex_btn_confirmar" class="btn btn-danger">
          <i class="fas fa-trash-alt me-1"></i> Excluir
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast de cópia -->

<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
  <div id="toast-copy" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body"><i class="fas fa-check-circle me-2"></i> Simulação copiada com sucesso!</div>
      <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- =======================
     STYLE LOCAL
======================= -->

<style>
.table-clean thead th {
  background:#fafafa;font-weight:600;font-size:.85rem;border-bottom:1px solid #eee;
}
.table-clean tbody td { vertical-align:middle;font-size:.9rem; }
.table-clean tbody tr:hover { background-color:#f6f9fc; }
.page-link { color:#ff5e00;border:none; }
.page-item.active .page-link { background:#ff5e00;border:none;color:#fff; }
.btn-light:hover { background:rgba(0,0,0,.04); }

.fade-in { opacity:1; transition:opacity .2s ease-in-out; }
.fade-in.loading { opacity:.4; pointer-events:none; }
.spinner-inline {
  width:20px;height:20px;border:2px solid #ccc;border-top-color:#ff5e00;
  border-radius:50%;animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>

<!-- =======================
     SCRIPT PRINCIPAL
======================= -->

<script>
(function(){
  const listaEl = document.getElementById('produtosLista');
  const formFiltros = document.getElementById('formFiltros');
  const perPageSel = document.getElementById('per_page');
  const formPerPage = document.getElementById('formPerPage');
  const inTermo = document.getElementById('inTermo');
  const spinner = document.getElementById('spinnerBusca');

  function serializeForm(form){
    const fd = new FormData(form);
    const params = new URLSearchParams();
    for (const [k,v] of fd.entries()){
      if (v !== null && v !== "") params.append(k,v);
    }
    return params;
  }

  async function carregarLista(params, push=true){
    try{
      if (spinner) spinner.style.display='inline-block';
      listaEl.classList.add('loading');
      params.set('ajax','1');
      const url = `${window.location.pathname}?${params.toString()}`;
      const resp = await fetch(url,{headers:{'X-Requested-With':'XMLHttpRequest'}});
      if(!resp.ok) throw new Error();
      const html = await resp.text();
      listaEl.innerHTML = html;
      if(push){
        const clean = params.toString().replace(/(&)?ajax=1/,'');
        history.pushState(null,'',`${window.location.pathname}?${clean}`);
      }
      listaEl.classList.remove('loading');
      if (spinner) spinner.style.display='none';
      bindInteracoesLista();
    }catch(e){
      listaEl.classList.remove('loading');
      if (spinner) spinner.style.display='none';
      console.warn('[M4] Erro AJAX', e);
    }
  }

  function debounce(fn,ms){
    let t;
    return (...a)=>{
      clearTimeout(t);
      t=setTimeout(()=>fn(...a),ms);
    };
  }

  if(inTermo){
    inTermo.addEventListener('input',debounce(()=>{
      const termo=inTermo.value.trim();
      if(termo.length===0||termo.length>=2){
        const params=serializeForm(formFiltros);
        params.set('page','1');
        carregarLista(params);
      }
    },700));
  }

  if(formFiltros){
    formFiltros.addEventListener('change',ev=>{
      if(ev.target.tagName==='SELECT'){
        const p=serializeForm(formFiltros);
        p.set('page','1');
        carregarLista(p);
      }
    });
    formFiltros.addEventListener('submit',ev=>{
      ev.preventDefault();
      const p=serializeForm(formFiltros);
      p.set('page','1');
      carregarLista(p);
    });
  }

  if(perPageSel && formPerPage){
    perPageSel.addEventListener('change',()=>{
      const p=serializeForm(formPerPage);
      p.set('page','1');
      carregarLista(p);
    });
  }


  /* ===========================================================
     FUNÇÃO PRINCIPAL — INTERAÇÃO COM A LISTA
  =========================================================== */
  function bindInteracoesLista(){

    /* PAGINAÇÃO */
    listaEl.querySelectorAll('.pagination a.page-link').forEach(a=>{
      a.addEventListener('click',ev=>{
        ev.preventDefault();
        const u=new URL(a.href,window.location.origin);
        const params=u.searchParams;
        carregarLista(params);
      });
    });

    /* BOTÃO WHATSAPP */
    listaEl.querySelectorAll(".btn-whatsapp").forEach(btn=>{
      btn.addEventListener("click",async e=>{
        e.preventDefault();
        const textoJa=btn.getAttribute("data-texto-completo");
        if(textoJa){
          try{
            await navigator.clipboard.writeText(textoJa);
            new bootstrap.Toast(document.getElementById("toast-copy")).show();
            btn.removeAttribute("data-texto-completo");
            btn.innerHTML='<i class="fab fa-whatsapp text-success"></i>';
          }catch{
            alert("Erro ao copiar. Verifique permissões do navegador.");
          }
          return;
        }
        if(!btn.hasAttribute("data-loading")){
          btn.setAttribute("data-loading","true");
          const id=btn.getAttribute("data-produto-id");
          const original=btn.innerHTML;
          btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';
          try{
            const r=await fetch(`/api/produto/${id}/whatsapp`);
            if(!r.ok) throw new Error();
            const d=await r.json();
            btn.setAttribute("data-texto-completo",d.texto_completo);
            btn.innerHTML='<i class="fas fa-copy"></i> Copiar';
          }catch{
            alert("Erro ao gerar simulação.");
            btn.innerHTML=original;
          }finally{
            btn.removeAttribute("data-loading");
          }
        }
      });
    });

    /* BOTÃO EXCLUIR */
    listaEl.querySelectorAll(".btn-excluir").forEach(btn=>{
      btn.addEventListener("click",()=>{
        document.getElementById("ex_nome").textContent = btn.getAttribute("data-nome") || "—";
        document.getElementById("ex_sku").textContent = btn.getAttribute("data-sku") || "—";
        const id = btn.getAttribute("data-id");
        const href = `/produtos/${id}/excluir`;
        const confirmBtn = document.getElementById("ex_btn_confirmar");
        const novo = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(novo,confirmBtn);
        novo.addEventListener("click",async(ev)=>{
          ev.preventDefault();
          try{
            const r=await fetch(href,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"}});
            if(r.ok){ location.reload(); }
            else { alert("Erro ao excluir."); }
          }catch{ alert("Erro ao excluir."); }
        });
        new bootstrap.Modal(document.getElementById("modalExcluirProduto")).show();
      });
    });

    /* BOTÃO VISUALIZAR */
    listaEl.querySelectorAll(".btn-visualizar").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.dataset.produtoId;
        const r = await fetch(`/produtos/${id}/visualizar`);
        if (!r.ok){
          alert("Erro ao buscar produto.");
          return;
        }
        const p = await r.json();

        console.debug("[M4] visualizar_produto:", p);
        console.debug("[M4] URL da foto recebida:", p.foto_url);

        // FOTO
        const img = document.getElementById("vp_foto");
        if (img) {
          img.removeAttribute('crossorigin'); // REMOVER ESTA LINHA SE EXISTIR
          img.src = "";
  
          if (p.foto_url) {
            img.src = p.foto_url; // A URL já vem pronta do proxy
            img.onerror = () => { img.src = "/static/img/placeholder.jpg"; };
          } else {
            img.src = "/static/img/placeholder.jpg";
          }
        }
        // DADOS
        document.getElementById("vp_nome").textContent = p.nome || "";
        document.getElementById("vp_codigo").textContent = p.codigo ? `Código: ${p.codigo}` : "";
        document.getElementById("vp_categoria").textContent = p.categoria || "-";
        document.getElementById("vp_marca").textContent = p.marca || "-";
        document.getElementById("vp_calibre").textContent = p.calibre || "-";
        document.getElementById("vp_tipo").textContent = p.tipo || "-";
        document.getElementById("vp_funcionamento").textContent = p.funcionamento || "-";
        document.getElementById("vp_descricao").textContent = p.descricao || "";

        // PREÇOS
        document.getElementById("vp_preco_avista").textContent = p.preco_avista || "R$ 0,00";
        document.getElementById("vp_preco_parcelado").textContent = p.parcelado_label || "-";

        // PARCELAS
        const corpo = document.getElementById("vp_parcelas");
        if (corpo) {
          corpo.innerHTML = "";
          (p.parcelas || []).forEach(l => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${l.rotulo}</td>
              <td>${l.parcela}</td>
              <td class="text-end pe-3">${l.total}</td>
            `;
            corpo.appendChild(tr);
          });
        }

        new bootstrap.Modal(document.getElementById("modalVisualizarProduto")).show();
      });
    });
  }


  /* ======================================
     CHAMADA INICIAL
  ====================================== */
  bindInteracoesLista();


  window.addEventListener('popstate',()=>{
    const p=new URLSearchParams(window.location.search);
    carregarLista(p,false);
  });

})();
</script>

{% include 'produtos/modal_visualizar.html' %}

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
document.getElementById("vp_btn_print").addEventListener("click", async () => {
  const originalArea = document.getElementById("vp_area_print");
  
  // 1. Clona a área para limpar interferência do Modal
  const clone = originalArea.cloneNode(true);
  clone.style.position = "absolute";
  clone.style.top = "-9999px"; // Esconde da visão do usuário, mas deixa renderizável
  clone.style.left = "0";
  clone.style.width = "800px"; 
  clone.style.backgroundColor = "#ffffff";
  clone.style.padding = "20px";
  
  document.body.appendChild(clone);

  try {
      const canvas = await html2canvas(clone, { 
          scale: 2, 
          backgroundColor: "#ffffff",
          useCORS: true,     // Pega a foto do Proxy
          allowTaint: false,
          logging: false,
          windowWidth: 800,
          windowHeight: clone.scrollHeight
      });

      canvas.toBlob(blob => {
        if (!blob) return;
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "ficha_produto.png";
        a.click();
        URL.revokeObjectURL(url);
      });

  } catch (e) {
      console.error("Erro print:", e);
  } finally {
      document.body.removeChild(clone);
  }
});

</script>

{% endblock %}